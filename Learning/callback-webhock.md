
## ๐ค ุฑุฏู ูู ุงูุงูุชุฑููู (ุจุงูุนุฑุจู)

> "ุฃููุฉ ุทุจุนูุงุ ุจูุงุจุงุช ุงูุฏูุน ุจูุจูู ูููุง ูุฐุง ุทุฑููุฉ ููู Integration ุนูู ุญุณุจ ููุน ุงููุดุฑูุน ูุฏุฑุฌุฉ ุงูู control ุงููู ุนุงูุฒูุง. ุบุงูุจูุง ุงูุทุฑู ุงูุฃุณุงุณูุฉ 3:

 1.ุงู  **Hosted Payment Page (Redirect Integration):**
    ุฏู ุฃุจุณุท ุทุฑููุฉุ ุงููุณุชุฎุฏู ุจูุชุญูู ูุตูุญุฉ ุฌุงูุฒุฉ ูู ุจูุงุจุฉ ุงูุฏูุนุ ูุฏุฎู ุจูุงูุงุช ุงููุงุฑุช ููุงูุ ูุจุนุฏ ูุฏู ุจูุชุญูู ูุฑุฌุน ุนูุฏู ูู Success ุฃู Fail URL.
    ููุฒุฉ ุงูุทุฑููุฉ ุฏู ุฅููุง ุขููุฉ ุฌุฏูุง ูุฃู ูู ุญุงุฌุฉ ุจุชุญุตู ุนูุฏ ูุฒูุฏ ุงูุฎุฏูุฉ.
>
 2.ุงู  **Embedded Checkout (iFrame/JS SDK):**
    ููุง ุงููููุฐุฌ (form) ุจุชุงุน ุงูุฏูุน ุจูุธูุฑ ุฌูุง ูููุนู ุนู ุทุฑูู iFrame ุฃู JavaScript SDK.
    ูุฏู ุงููุณุชุฎุฏู ุจููุถู ูู ูููุนูุ ููู ุงูุจุทุงูุงุช ุจุชุชุจุนุช ูุจุงุดุฑุฉ ููู Gateway.
    ุฏู ุจุชุฏู User Experience ุฃุญุณู ุดููุฉุ ููุณู ุขููุฉ.
>
 3.ุงู  **Direct API Integration (Server-to-Server):**
    ููุง ุฃูุง ุงููู ุจุนูู Collect ููุจูุงูุงุช ูุฃุจุนุชูุง ูุจุงุดุฑุฉ ููู Payment Gateway API.
    ุงูุทุฑููุฉ ุฏู ุจุชุฏููู Full Control ูู ุงููุงุฌูุฉ ูุชุฌุฑุจุฉ ุงููุณุชุฎุฏูุ ุจุณ ุฃูุง ุงููู ูุณุคูู ุนู ุงูุฃูุงู ุจุงููุงูู (ุฒู PCI DSS compliance).
    ุบุงูุจูุง ุงูุดุฑูุงุช ุงููุจูุฑุฉ ุฃู ุงูุชุทุจููุงุช ุงูููุจุงูู ูู ุงููู ุจุชุญุชุงุฌูุง."

---

## ๐ข ุงูุชูุถูุญ ุฃูุชุฑ ูู (ุนุดุงู ุชููููุง ุจุนูู):

ุงููุง  **Redirect (Hosted Page):**

   * ุฒู ูุง PayPal ู Fawry ุจูุนูููุง.
   * ุงูุนููู ูุชูุฌู ุจุฑุฉ ุนูุฏููุ ูุฏุฎู ุจูุงูุงุชูุ ูุฑุฌุนูู.
   * ุฃูุชุฑ ุญุงุฌุฉ ุฃูุงู ูุฃูู ุตุฏุงุน.

ุซุงููุง **iFrame/Widget/JS Plugin:**

   * ุฒู Fawaterk plugin ุงููู ุฃูุช ูุณู ููุช ุจุชุฌุฑุจู.
   * ุจูุนุฑุถูู ุงูู checkout ุฌูุง ุตูุญุชู.
   * ุจูุฏูู ูุฑููุฉ ูู ุงูุชุตููู + ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃุญุณู.

ุซุงูุซุง **Direct API:**

   * ุฃูุช ุชุจูู UI ุจุชุงุนู ุจุงููุงูู.
   * ุชุจุนุช ุจูุงูุงุช ุงููุฑูุช ุฃู ุงูุชูููู ููู Gateway.
   * ูุญุชุงุฌุฉ ุดูุงุฏุงุช ุฃูุงู (PCI DSS) ูุชุดููุฑ.
   * ููุงุณุจุฉ ููุดุฑูุงุช ุงููู ุนุงูุฒุฉ Full control (ุฒู Uber ุฃู Amazon).

---

## ๐ ุงูุฎูุงุตุฉ ุงููู ุชููููุง ูู ุงูุงูุชุฑููู:

> "ุงูู integration ูููู ูุชุนูู ุจุซูุงุซ ุทุฑู ุฑุฆูุณูุฉ: Redirect ูุตูุญุฉ ุงูุฏูุนุ Embedded iFrame/JS SDKุ ุฃู Direct API Integration. ูู ุทุฑููุฉ ูููุง ูููุฒุงุช ูุนููุจุ ูุงูุงุฎุชูุงุฑ ุจูุนุชูุฏ ุนูู ุญุฌู ุงููุดุฑูุน ููุชุทูุจุงุชู ูู ุญูุซ ุงูุฃูุงู ูุชุฌุฑุจุฉ ุงููุณุชุฎุฏู."

---

## ๐น 1. ูุนูู ุฅูู SDKุ

**SDK = Software Development Kit**

* ุนุจุงุฑุฉ ุนู **ุฃุฏูุงุช + ููุชุจุงุช + Documentation** ุจููุฏููุงูู ูุฒูุฏ ุงูุฎุฏูุฉ (ุฒู ุจูุงุจุฉ ุงูุฏูุน) ุนุดุงู ุชุณูู ุนููู ุงูุชูุงูู ูุนุงู.
* ุจุฏู ูุง ุชูุชุจ ูู ุญุงุฌุฉ ูู ุงูุตูุฑุ ูู ุจูุฏูู SDK ุฌุงูุฒ: ูููู ูููู JavaScript SDK (ูููุชุตูุญ)ุ ุฃู SDK ููู .NET ุฃู Java ุฃู Python.

**ูุซุงู:**
ูู ุนุงูุฒ ุชุฏูุฌ PayPal ูู ูููุนูุ ูุด ูุงุฒู ุชุนูุฏ ุงุฎุชุฑุงุน ุงูุนุฌูุฉ ูุชูุชุจ ูู ุงูููุฏ ุงููู ูุชุนุงูู ูุน ุงูู APIs.
ูู ุจูุฏูู JavaScript SDK ุชูุชุจู ุจุณ ูุฏู:

```html
<script src="https://www.paypal.com/sdk/js?client-id=YOUR_CLIENT_ID"></script>
```

ููู ุฌุงูุฒ ูุฏูุฑูู ุฒุฑุงุฑ ุงูุฏูุน ููู ุงููู ูุฑุงู.

ุงู SDK ูุนูู = "ุตูุฏูู ุฃุฏูุงุช" ุฌุงูุฒ ูุณููููู ุงูุงูุชุฌุฑูุดู.

---

## ๐น 2. ูุนูู ุฅูู PCI DSS Complianceุ

ุงู **PCI DSS = Payment Card Industry Data Security Standard**

* ุฏู **ูุนูุงุฑ ุนุงููู ููุฃูุงู** ุจูุชูุฑุถ ุนูู ุฃู ุดุฑูุฉ ุจุชุชุนุงูู ูุน ุจูุงูุงุช ูุฑูุช ุงูุงุฆุชูุงู.
* ุงุชุนูู ูู ุดุฑูุงุช ุงูุจุทุงูุงุช ุงููุจูุฑุฉ (Visa, MasterCard, American Express).
* ุจููููู: ูู ูุชุฎุฒู ุฃู ุชุนุงูุฌ ุจูุงูุงุช ูุงุฑุช ุงูุนููู ุนูุฏูุ ูุงุฒู ุชูุชุฒู ุจูุนุงููุฑ ุตุงุฑูุฉ ุฒู:

  * ูู ุงูุฏุงุชุง ูุชุดูุฑุฉ.
  * ุงูุณูุฑูุฑุงุช ูุนูููุฉ ููุง Firewall ููู.
  * ูู Monitoring logs ุฏุงุฆู.
  * ูููุด Access ุนุดูุงุฆู.
  * ุงุฎุชุจุงุฑุงุช Penetration Testing ุจุงุณุชูุฑุงุฑ.

**ุจุงูุนุฑุจู:**

* ูู ูุชุนูู Direct API Integration ูุชุฌูุน ุจูุงูุงุช ุงููุฑูุช ุนูุฏูุ ูุงุฒู ุดุฑูุชู ุชุงุฎุฏ ุดูุงุฏุฉ PCI DSS.
* ุนุดุงู ูุฏู ูุนุธู ุงูุดุฑูุงุช ุงูุตุบูุฑุฉ ูุงููุชูุณุทุฉ **ุชูุฑุจ ูู ุงูุทุฑููุฉ ุฏู** ูุชุณุชุฎุฏู Redirect ุฃู iFrameุ ูุฃู ุงูู Gateway ููุณู ูู ุงููู compliant ูุฃูุช ูู ุงูุฃูุงู.

---

## ๐ค ุฅุฒุงู ุชููููุง ูู ุงูุงูุชุฑููู:

> ุงู "SDK ูู ุนุจุงุฑุฉ ุนู ููุชุจุงุช ูุฃุฏูุงุช ุฌุงูุฒุฉ ุจูุฏููุงูู ูุฒูุฏ ุงูุฏูุน ุนุดุงู ุฃูุฏุฑ ุฃุนูู Integration ุจุณูููุฉุ ุฒู JavaScript SDK ุงููู ุจูุนุฑุถ ุฒุฑุงุฑ ุฏูุน ุฃู Checkout form.
>
> ูุจุงููุณุจุฉ ูู PCI DSSุ ุฏู ูุนูุงุฑ ุนุงููู ููุฃูุงู ุฎุงุต ุจุจุทุงูุงุช ุงูุฏูุนุ ุฃู ุดุฑูุฉ ุจุชุฎุฒู ุฃู ุชุนุงูุฌ ุจูุงูุงุช ุงูุจุทุงูุงุช ูุงุฒู ุชูุชุฒู ุจูู. ุนุดุงู ูุฏู Direct API Integration ุจูููู ุฃุตุนุจ ุดููุฉ ูุฃูู ุจูุฎูููู ูุณุคูู ุนู ุงูุฃูุงู ูุงูู complianceุ ุนูุณ ุงูุทุฑู ุงูุชุงููุฉ ุงููู ุจุชุญูู ุงูุนุจุก ุนูู ุงูู gateway ููุณู."

---


## 4๏ธโฃ ุฃููุงุน ุงูู Payment Integration

ุง 1. **Hosted Payment Page (Redirect)**

   * ุงูุนููู ุจูุชุญููู ุนูู ุตูุญุฉ ุงูุฏูุน ุจุชุงุนุฉ ุงูู Gateway (ุฒู PayPal, Fawry).
   * ูููุฒุงุชูุง: ุณููุฉ ููุฃูููุฉ.
   * ุนูุจูุง: ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู ุจุชุทูุน ุจุฑู ูููุนู.

ุง 2. **Embedded Form / iFrame**

   * ููุฑู ูู ุงูู Gateway ูุชุนุฑุถ ุฌูุฉ ูููุนู.
   * ุงูุนููู ูุด ุจูุณูุจ ูููุนู.
   * ุฃูุงู ูุชูุณุท (ุฃูุช ูุด ุจุชุฎุฒู ุจูุงูุงุช ุงููุงุฑุชุ ุจุณ ุจุชุนุฑุถูุง).

ุง 3. **Direct API Integration**

   * ูููุนู ูุงุฎุฏ ุจูุงูุงุช ุงููุงุฑุช ููุจุนุชูุง ููู Gateway API.
   * ูุญุชุงุฌ PCI DSS compliance (ูุณุคูููุฉ ุฃุนูู).
   * ุจุชุญูู ุฃูุชุฑ ูู ุชุฌุฑุจุฉ ุงููุณุชุฎุฏู.

---
## ูู Challenges ุจุชุธูุฑ ูู ุงูุงูุชุฑููู

* **ุงูุฃูุงู**: ููู ููุฎุฒูุด ุจูุงูุงุช ุงููุงุฑุชุ (ุนูุดุงู PCI DSS).
* ุง **Handling Failures**: ูู ุงูุนูููุฉ ูุดูุช (declined) ุจุชุนูู retry ุฅุฒุงูุ
* ุง **Idempotency**: ุฅุฒุงู ุชููุน double paymentุ (ุจุงุณุชุฎุฏุงู transaction id).
* ุง **Refunds/Chargebacks**: ุงููุฑู ุจูููู.
* ุง **Currency Conversion**: ุงูุชุนุงูู ูุน multi-currency.
* ุง **Recurring Payments**: ุฅุฒุงู ุชุนูู ุงุดุชุฑุงูุงุช ุจุฏูู ูุง ุชุนูุฏ ุฅุฏุฎุงู ุงููุงุฑุชุ (Tokenization).

---

## 8๏ธโฃ ุฅุฌุงุจุงุช ุณุฑูุนุฉ ูููู ุชูุฌู ูู ุงูุงูุชุฑููู

- *ููู ุจูุณุชุฎุฏู Payment Gatewayุ*
> ุนูุดุงู ูููุฑ ุฃูุงู (Encryption, PCI DSS)ุ ูุณูู ุงูุฏูุฌ (API/SDK)ุ ููุนูู ููุณูุท ุจูู ุงูุชุงุฌุฑ ูุงูุจููู.

- *ุฅูู ุงููุฑู ุจูู Authorization ู Captureุ*
> ุง Authorization ุจูุนูู hold ูููููุณ. Capture ุจูุฎุตููุง ูุนูููุง.

- *ุฅูู ุงููุฑู ุจูู Refund ู Chargebackุ*
> ุง Refund ุจูุฑุฌูุน ูููุณ ูู ุงูุชุงุฌุฑ ููุนููู. Chargeback ุงูุนููู ููุณู ูุนุชุฑุถ ุนูุฏ ุงูุจููุ ูุงูุจูู ูุณุญุจ ุงููููุณ ุจุงูููุฉ.

- *ุฅูู ููุงูุฏ ุงูู Tokenizationุ*
> ุจุฏู ูุง ุชุฎุฒู card numberุ ุจุชุฎุฒู token. ุฏู ุจูููู ูุฎุงุทุฑ ุงูุงุฎุชุฑุงู.

- *ุฅูู ููุงูุฏ Webhooksุ*
> ุชุนุฑู ุชุญุฏูุซ ุญุงูุฉ ุงูุฏูุน (success/fail/refund) ูู ุบูุฑ ูุง ุชุนุชูุฏ ุจุณ ุนูู response ุฃููู.


---



ุงูู **Webhook** ูู ูู ุงูุขุฎุฑ ูุฌุฑุฏ **HTTP Request (ุนุงุฏุฉ POST)** ุจูุฌููู ูู ุงูู Payment Gateway ุนูู Endpoint ุฅูุช ุนุงููู ุนูุฏู ูู ุงูู API.

### 1- ุดูู ุงูู Request ุจูููู ุฅุฒุงูุ

* ุจูุฌููู **POST Request** ุนูู ุงูู URL ุงููู ุฅูุช ูุณุฌูู ุนูุฏ ุงูู Gateway (ูุซูุงู: `https://myapp.com/api/webhooks/payment`).
* ุงูู Body ุจูููู ุบุงูุจูุง **JSON** ููู ุชูุงุตูู ุงูุญุฏุซ (Event) ุงููู ุญุตูุ ูุซุงู:

```json
{
  "id": "evt_12345",
  "type": "payment_success",
  "data": {
    "transactionId": "tx_98765",
    "amount": 5000,
    "currency": "USD",
    "status": "succeeded",
    "customerEmail": "user@example.com"
  }
}
```

ูููู ุงูููุน ูููู ูุฎุชูู ุญุณุจ ุงูู Gateway: ุฒู `payment_failed`, `refund_issued`, ุฅูุฎ.

---

### 2- ุฅุฒุงู ุฃุชุฃูุฏ ุฅู ุงูุฑููููุณุช ุฏู ุฌุงู ูู ุงููุตุฏุฑ ุงูุตุญ ูุด ุญุฏ ุจูููุฑููุ

ููู ุทุฑู ูุฎุชููุฉ ูุงูู Gateways ุนุงุฏุฉ ุจุชููุฑ ูุงุญุฏุฉ ุฃู ุฃูุชุฑ:

#### โ ุฃ- **Secret Key / Signature Verification** (ุงูุฃุดูุฑ):

* ูุน ูู Webhookุ ุงูู Gateway ุจูุจุนุช Header ููู ุชูููุน (Signature).
* ุฅูุช ุจุชุงุฎุฏ ุงูู Body ุฒู ูุง ูู + Secret Key (ุงููู ุนูุฏู) ูุชุนูู Hash ุจููุณ ุงูุฎูุงุฑุฒููุฉ (ุนุงุฏุฉ HMAC-SHA256).
* ูู ุงูุชูููุน ุงููู ุฅูุช ุทูุนุชู = ุงููู ูู ุงูู Header โ ูุจูู ุงูุฑููููุณุช ุฃุตูู.
* ูุซุงู Header ูู Stripe:

  ```
  Stripe-Signature: t=1234567890,v1=abcdef123456
  ```

#### โ ุจ- **IP Whitelisting**:

* ุจุนุถ Gateways ุจุชูููู: "ุงูู Webhook ููุฌููู ูู IP ranges ูุนููุฉ"ุ ูุฅูุช ุชุชุญูู ุฅู ุงูู Request ุฌุงู ูู IP ุถูู ุงููู ูุงูููู ุนููู.

#### โ ุฌ- **Basic Authentication / API Key in Header**:

* ุฃุญูุงููุง ุจูุจุนุชูุง ูุน ูู Webhook API Key ุฃู Token ูู ุงูู Header ูุฅูุช ุชุชุญูู ุฅูู ุตุญูุญ.

---

### 3- ุฅุฒุงู ุชุชุนุงูู ุนููููุงุ

* ุชุนูู Controller ุฃู Endpoint ูุฎุตุต ุฒู:

```csharp
[ApiController]
[Route("api/webhooks")]
public class WebhookController : ControllerBase
{
    [HttpPost("payment")]
    public IActionResult HandlePaymentWebhook([FromBody] JsonElement payload)
    {
        // Step 1: Verify Signature (depends on gateway)
        var signature = Request.Headers["X-Signature"];
        bool isValid = VerifySignature(payload, signature);

        if (!isValid)
            return Unauthorized();

        // Step 2: Process Event
        var eventType = payload.GetProperty("type").GetString();
        if (eventType == "payment_success")
        {
            var transactionId = payload.GetProperty("data").GetProperty("transactionId").GetString();
            // Update Order status in DB
        }

        // Step 3: Return 200 OK ุนุดุงู ุงูู Gateway ูุนุฑู ุฅูู ุงุณุชูุจูุช ุงูุญุฏุซ
        return Ok();
    }
}
```

---

### 4- ููู Webhook ูููุ

ูุฃูู ุจูุญู ุงููุดููุฉ ุงููู ุฅูุช ุณุฃูุช ุนููุง ูุจู ูุฏู:
ูู ุงููุช ูุทุน ูุงููุณุชุฎุฏู ูุง ูุตูุด ูู Order Confirmation Page โ ุงูู Webhook ูููุตูู ู ุชุนุฑู ุฅู ุงูุฏูุน ุชู ูุชุญุฏุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุญุชู ูู ุงูุนููู ูุดุงูุด.

---


---

## ๐ข ุฃููุงู: ุงูุฑูููุณุช ุจูุฌู ุฅุฒุงูุ

* ุงูู **Webhook** ูู ุงูุฃุณุงุณ ูุฌุฑุฏ **HTTP POST Request** ุงูุฌูุชูุงู ุจูุจุนุชูู ุนูู URL ุฅูุช ูุญุฏุฏู.
* ุจูุจุนุช ูู ุงูู Body ุจุชุงุน ุงูุฑูููุณุช **JSON Payload** ููู ุชูุงุตูู ุงูุญุฏุซ (Event).

### ูุซุงู ุนุงู (JSON ุฌุงู ูู Payment Gateway):

```json
{
  "event": "payment_succeeded",
  "transaction_id": "tx_123456789",
  "order_id": "ord_987654321",
  "amount": 5000,
  "currency": "EGP",
  "status": "succeeded",
  "timestamp": "2025-09-11T09:30:00Z"
}
```

* ุงู `event` โ ููุน ุงูุญุฏุซ (ูุฌุงุญุ ูุดูุ Pendingุ Refundโฆ).
* ุงู `transaction_id` โ ุฑูู ุงูุนูููุฉ ุนูุฏ ุงูู Gateway.
* ุงู `order_id` โ ุงูุฃูุฑุฏุฑ ุนูุฏู ุงููู ุงุชุฑุจุท ุจููุง.
* ุงู `status` โ ุงูุญุงูุฉ ุงูููุงุฆูุฉ.

ุฅูุช ูู ูุงุญูุชู ุชุณุชูุจู ุฏู ูู **Endpoint** ุนูุฏู (ูุซูุงู `/api/payment/webhook`).

---

## ๐ข ุซุงููุงู: ุฅุฒุงู ุชุชุฃูุฏ ุฅู ุงูุฑูููุณุช ูุนูุงู ูู ุงูู Gateway ูุด Fakeุ

ุฃู Payment Gateway ูุญุชุฑู ุจูุฏูู ูุณููุฉ ุชุญููุ ุบุงูุจูุง ูุงุญุฏุฉ ูู ุฏูู:

### 1. **Signature Header** (ุงูุฃูุซุฑ ุดููุนูุง)

* ุงูุฌูุชูุงู ุจูุถูู Header ูู ุงูุฑูููุณุช ุฒู:
  `X-Signature` ุฃู `Stripe-Signature` ุฃู `Paymob-Signature`.
* ูู ุจูุนูู HMAC (ุชุดููุฑ) ููู Body ุจุงุณุชุฎุฏุงู Secret Key.
* ุฅูุช ูู ูุงุญูุชู ุชุนูุฏ ุญุณุงุจ ุงูู HMAC ูุชูุงุฑู ุจุงููู ุฌุงูู.

```csharp
using System.Security.Cryptography;
using System.Text;

bool VerifySignature(string payload, string signature, string secret)
{
    var keyBytes = Encoding.UTF8.GetBytes(secret);
    using var hmac = new HMACSHA256(keyBytes);
    var hash = hmac.ComputeHash(Encoding.UTF8.GetBytes(payload));
    var computed = BitConverter.ToString(hash).Replace("-", "").ToLower();
    return computed == signature.ToLower();
}
```

### 2. **IP Whitelisting**

* ุจุนุถ Gateways ุจููููู: "ุฅุญูุง ุจูุจุนุช Webhooks ุจุณ ูู IP ranges ูุนููุฉ".
* ูุชุชุฃูุฏ ุฅู ุงูุฑูููุณุช ุฌุงู ูู IP ูุตุฑุญ ุจูู.
  (ูุด ููุงูุฉ ููุญุฏูุงุ ุจุณ ุจูุฒูุฏ ุฃูุงู).

### 3. **Secret Token**

* ุฃุญูุงููุง ูุทูุจูุง ููู ุชุญุท "Secret Token" ูู URL ุฃู Header.
* ูุซูุงู:
  `https://mydomain.com/api/payment/webhook?token=XYZ123`
* ูุงูู Gateway ูุจุนุชู ูู ูุฑุฉ ูุฅูุช ุชุชุญูู ููู.

---

## ๐ข ุซุงูุซุงู: ุฅุฒุงู ุชุชุนุงูู ูุน ุงูู Webhook ุจุนุฏ ูุง ุชุชุฃูุฏุ

ุงูู ุญุงุฌุฉ Parse JSON.
ุชุงูู ุญุงุฌุฉ Verify signature (ุฃู ุงูุทุฑููุฉ ุงููู ุจูููุฑูุง ุงูู Gateway).
3. ุจูุงุกู ุนูู `event` ุฃู `status`:

   * ูู `payment_succeeded` โ ุชุญุฏุซ Order ูู DB ุฅูู "Paid".
   * ูู `payment_failed` โ ุชุญุฏุซ Order ุฅูู "Failed".
   * ูู `refund` โ ุชุญุฏุซ Order ุฅูู "Refunded".
4. ุชุฑุฌุน Response ุจู **200 OK** ููุฌูุชูุงู โ ูุฏู ูู ุนุงุฑู ุฅูู ุงุณุชูุจูุช.

---

## ๐ข ุงูุณููุงุฑูู ุงูุตุญ

* ุงูู **Webhook ูู ุงูู Source of Truth**.
* ุงูู Redirect URL (success/fail page) ูุฌุฑุฏ **User Experience**.
* ูุนูู ูู ุงููุณุชุฎุฏู ูุงูุตูุด Success pageุ ุนูุฏู ุจุฑุถู Webhook ูุซุจุช ูุฌุงุญ ุงูุฏูุน.

---

## ๐ข ุฅุฌุงุจุฉ ูู ุงูุงูุชุฑููู:

ูู ุณุฃูู: "ุฅุฒุงู ุชุถูู ุฅู ุงูู Webhook ุงููู ุฌุงูู ุญููููุ"
ุชููู:

> "ุฃูุง ุจุนูู Verify ููู Webhook ุฅูุง ุนู ุทุฑูู Signature (HMAC using secret key) ุฃู Token ุฃู IP Whitelist ุญุณุจ ุงููู ุจูููุฑู ุงูู Gateway. ูุฏู ุฃุชุฃูุฏ ุฅู ุงูุฑูููุณุช ุฌุงู ูู ูุตุฏุฑ ุฑุณูู ูุด ุญุฏ ุจูุนูู Fake POST."

---

ุชูุงูุ ุฑูุฒ ูุนุงูุง ๐

ุงูู **Webhook** ูู ูู ุงูุขุฎุฑ ูุฌุฑุฏ **HTTP Request (ุนุงุฏุฉ POST)** ุจูุฌููู ูู ุงูู Payment Gateway ุนูู Endpoint ุฅูุช ุนุงููู ุนูุฏู ูู ุงูู API.

### 1- ุดูู ุงูู Request ุจูููู ุฅุฒุงูุ

* ุจูุฌููู **POST Request** ุนูู ุงูู URL ุงููู ุฅูุช ูุณุฌูู ุนูุฏ ุงูู Gateway (ูุซูุงู: `https://myapp.com/api/webhooks/payment`).
* ุงูู Body ุจูููู ุบุงูุจูุง **JSON** ููู ุชูุงุตูู ุงูุญุฏุซ (Event) ุงููู ุญุตูุ ูุซุงู:

```json
{
  "id": "evt_12345",
  "type": "payment_success",
  "data": {
    "transactionId": "tx_98765",
    "amount": 5000,
    "currency": "USD",
    "status": "succeeded",
    "customerEmail": "user@example.com"
  }
}
```

ูููู ุงูููุน ูููู ูุฎุชูู ุญุณุจ ุงูู Gateway: ุฒู `payment_failed`, `refund_issued`, ุฅูุฎ.

---

### 2- ุฅุฒุงู ุฃุชุฃูุฏ ุฅู ุงูุฑููููุณุช ุฏู ุฌุงู ูู ุงููุตุฏุฑ ุงูุตุญ ูุด ุญุฏ ุจูููุฑููุ

ููู ุทุฑู ูุฎุชููุฉ ูุงูู Gateways ุนุงุฏุฉ ุจุชููุฑ ูุงุญุฏุฉ ุฃู ุฃูุชุฑ:

#### โ ุฃ- **Secret Key / Signature Verification** (ุงูุฃุดูุฑ):

* ูุน ูู Webhookุ ุงูู Gateway ุจูุจุนุช Header ููู ุชูููุน (Signature).
* ุฅูุช ุจุชุงุฎุฏ ุงูู Body ุฒู ูุง ูู + Secret Key (ุงููู ุนูุฏู) ูุชุนูู Hash ุจููุณ ุงูุฎูุงุฑุฒููุฉ (ุนุงุฏุฉ HMAC-SHA256).
* ูู ุงูุชูููุน ุงููู ุฅูุช ุทูุนุชู = ุงููู ูู ุงูู Header โ ูุจูู ุงูุฑููููุณุช ุฃุตูู.
* ูุซุงู Header ูู Stripe:

  ```
  Stripe-Signature: t=1234567890,v1=abcdef123456
  ```

#### โ ุจ- **IP Whitelisting**:

* ุจุนุถ Gateways ุจุชูููู: "ุงูู Webhook ููุฌููู ูู IP ranges ูุนููุฉ"ุ ูุฅูุช ุชุชุญูู ุฅู ุงูู Request ุฌุงู ูู IP ุถูู ุงููู ูุงูููู ุนููู.

#### โ ุฌ- **Basic Authentication / API Key in Header**:

* ุฃุญูุงููุง ุจูุจุนุชูุง ูุน ูู Webhook API Key ุฃู Token ูู ุงูู Header ูุฅูุช ุชุชุญูู ุฅูู ุตุญูุญ.

---

### 3- ุฅุฒุงู ุชุชุนุงูู ุนููููุงุ

* ุชุนูู Controller ุฃู Endpoint ูุฎุตุต ุฒู:

```csharp
[ApiController]
[Route("api/webhooks")]
public class WebhookController : ControllerBase
{
    [HttpPost("payment")]
    public IActionResult HandlePaymentWebhook([FromBody] JsonElement payload)
    {
        // Step 1: Verify Signature (depends on gateway)
        var signature = Request.Headers["X-Signature"];
        bool isValid = VerifySignature(payload, signature);

        if (!isValid)
            return Unauthorized();

        // Step 2: Process Event
        var eventType = payload.GetProperty("type").GetString();
        if (eventType == "payment_success")
        {
            var transactionId = payload.GetProperty("data").GetProperty("transactionId").GetString();
            // Update Order status in DB
        }

        // Step 3: Return 200 OK ุนุดุงู ุงูู Gateway ูุนุฑู ุฅูู ุงุณุชูุจูุช ุงูุญุฏุซ
        return Ok();
    }
}
```

---

### 4- ููู Webhook ูููุ

ูุฃูู ุจูุญู ุงููุดููุฉ ุงููู ุฅูุช ุณุฃูุช ุนููุง ูุจู ูุฏู:
ูู ุงููุช ูุทุน ูุงููุณุชุฎุฏู ูุง ูุตูุด ูู Order Confirmation Page โ ุงูู Webhook ูููุตูู ู ุชุนุฑู ุฅู ุงูุฏูุน ุชู ูุชุญุฏุซ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุญุชู ูู ุงูุนููู ูุดุงูุด.

---

## 1๏ธโฃ ูุนูู ุฅูู Callback / Webhookุ

* ุงู **Callback** = ุนูููุฉ ุงุณุชุฏุนุงุก ุจูุฑุฌุนูู ูููุง ุงูุณูุฑูุฑ ุจุชุงุน ุจูุงุจุฉ ุงูุฏูุน ุจุงููุชูุฌุฉ (ูุฌุญ ุงูุฏูุน / ูุดู / ููุบู).
* ุงู **Webhook** = ุทุฑููุฉ (URL) ุงูุช ุจุชุฌูุฒูุง ูู ุณูุณุชูู โ ุจูุงุจุฉ ุงูุฏูุน ุจุชุจุนุช ุนูููุง **Request (POST)** ููู ุชูุงุตูู ุงูุนูููุฉ ุจุนุฏ ูุง ุงูุนููู ูุฎูุต ุงูุฏูุน.

ุจูุนูู: ุจุฏู ูุง ุชูุถู ุชุณุฃู ุงูุจูุงุจุฉ ูู ุดููุฉ โูู ุงูุนููู ุฏูุน ููุง ูุณูุโ โ ูู ุจููุณูู ูุจุนุชููู ุฅุดุนุงุฑ (Notification) ุฃูู ูุง ูุญุตู ุชุบููุฑ ูู ุญุงูุฉ ุงูุฏูุน.

---

## 2๏ธโฃ ูุซุงู ูุงูุนู

* ูุญููุฏ ูุทูุจ ูุชุงุจ ูู ูููุนู.
* ุงูุช ุชุนูู **Invoice** ูู Paymob ุฃู PayTabs.
* ูุญููุฏ ูุฏูุน ุจูุงุฑุช ููุฒุง.
* ุงูุจูุงุจุฉ ุชุนูู ุงุชููู:

  1. ุชูุฑู ูุญููุฏ ุฑุณุงูุฉ โุชู ุงูุฏูุน ุจูุฌุงุญ โโ.
  2. ุชุจุนุชูู ุนูู **Webhook URL** ุงููู ุงูุช ูุนุฑูู ุนูุฏูู (ุฒู: `https://yourdomain.com/api/payment/callback`) โ JSON ููู:

     * ุงู `transaction_id`
     * ุงู `order_id`
     * ุงู `status` (paid, failed, pending)
     * ุงู `amount`

ุงูุช ุชุงุฎุฏ ุงูุจูุงูุงุช ุฏู ูุชุญุฏุซ ุงููDB ุนูุฏู:

* ูู **paid** โ ุชุบูุฑ ุญุงูุฉ ุงูุทูุจ ูู "ูุฏููุน".
* ูู **failed** โ ุชุนููู cancel ุฃู retry.

---

## 3๏ธโฃ ุงููุฑู ุจูู Callback ู Redirect

* ุงู **Redirect URL**: ุจุนุฏ ูุง ุงูุนููู ูุฏูุนุ ุจูุชุญูู ูุตูุญุฉ ุนูุฏู (ูุซูุงู `/payment/success`). ุฏู ุจุณ ุนุดุงู ููุฑูู ุฑุณุงูุฉ.
* ุงู **Webhook/Callback**: ุฏู ุงููู ุนููู ุงูุนููุฏุฉ โ ูุฃูู ุจูุจุนุชูู ูู ุงูุจูุงุจุฉ ููุณูุง ุฅุดุนุงุฑ ุฑุณูู ุฅู ุงููููุณ ุงุชุฏูุนุช. (ูููู ุงูุนููู ูููู ุงูุชุงุจ ุฃู ุงููุช ููุทุนุ ููู ุงููWebhook ููุฌููู ุจุฑุถู).

---

## 4๏ธโฃ ุง

 **ุฅูู ูู ุงููWebhook ูููู ููู ูู ุงูุฏูุน ุงูุฅููุชุฑูููุ**
   โ ูู URL ุจูุจุนุช ุนููู ูุฒููุฏ ุงูุฏูุน ุชูุงุตูู ุงูุนูููุฉ ุจุนุฏ ูุง ุชุฎูุตุ ุนุดุงู ุฃูุฏุฑ ุฃุนูู update ูู ุงูุณูุณุชู ุจุชุงุนู ุจุดูู ุขูู. ููู ููู ูุฃูู ูุถูู ุฅู ุงูุณูุณุชู ูุณุฌู ุงูุฏูุน ุญุชู ูู ุงูุนููู ูุง ุฑุฌุนุด ูููredirect page.

 **ุฅุฒุงู ุชุฃููู ุงููWebhookุ**
   โ ุฃุชุญูู ูู ุงูุชูููุน (signature ุฃู HMAC) ุงููู ุจุชุจุนุช ูุน ุงูุจูุงูุงุช. ูู ุจูุงุจุฉ ุจุชุฏูู secret key ุชุณุชุฎุฏูู ููุชุญูู ุฅู ุงูุฑูููุณุช ุฌุงู ูุนููุง ูููู ูุด ูู ูุงูุฑ.

 **ุฅูู ุงููู ูููู ูุญุตู ูู ูุง ุงุณุชุฎุฏูุชุด Webhookุ**
   โ ูุด ูุชุนุฑู ุญุงูุฉ ุงูุฏูุน ุจุฏูุฉ. ูููู ูุจูู ุงูุนููู ุฏูุน ููู ูุง ุฑุฌุนุด ููุตูุญุฉ โ ูุชูุชูุฑ ุฅูู ูุง ุฏูุนุด.

---


ูุซุงู ุนููู ูู **ASP.NET Core Web API** ูุนูู Webhook Endpoint ุฎุงุต ุจุงูุฏูุน:

---

##  ุงูุฎุทูุงุช

1. ูุชุฌูุฒ **Controller** ููู Action ุชุณุชูุจู POST ูู ุจูุงุจุฉ ุงูุฏูุน.
2. ูุชูุฑุฃ **JSON** ุงููู ุฌุงู ูู ุงูุจูุงุจุฉ.
3. ูุชุชุญูู ูู ุงูู **Signature** (ูู ุงูุจูุงุจุฉ ุจุชููุฑู) ุนุดุงู ุชุชุฃูุฏ ุฅู ุงูุฑูููุณุช ุตุญูุญ.
4. ุชุญุฏุซ ุญุงูุฉ ุงูุทูุจ ูู ุงููDatabase.

---

##  ุงูููุฏ

```csharp
using Microsoft.AspNetCore.Mvc;

namespace PaymentIntegrationDemo.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class PaymentWebhookController : ControllerBase
    {
        [HttpPost("callback")]
        public IActionResult PaymentCallback([FromBody] PaymentWebhookRequest request)
        {
            // Example: Log or process the payment data
            if (request.Status == "paid")
            {
                // TODO: Update order in database
                Console.WriteLine($"Order {request.OrderId} has been paid successfully.");
            }
            else if (request.Status == "failed")
            {
                // TODO: Handle failed payment
                Console.WriteLine($"Order {request.OrderId} payment failed.");
            }

            // Return 200 OK to acknowledge receipt
            return Ok(new { message = "Webhook received successfully" });
        }
    }

    // This is a model to map the JSON body from the payment gateway
    public class PaymentWebhookRequest
    {
        public string TransactionId { get; set; }
        public string OrderId { get; set; }
        public string Status { get; set; }
        public decimal Amount { get; set; }
    }
}
```

---

## ูุซุงู ุนูู ุงู JSON ูููู ููุตููุง ูู ุงูุจูุงุจุฉ

```json
{
  "transactionId": "TX123456",
  "orderId": "ORD789",
  "status": "paid",
  "amount": 500.00
}
```

---

##  ููุงุญุธุงุช ูููุฉ

* ูุงุฒู ุชุนุฑู ุงูู **Webhook URL** ุจุชุงุนู ููุจูุงุจุฉ (ูุซูุงู: `https://yourdomain.com/api/paymentwebhook/callback`).
* ูู ุจูุงุจุฉ ุจุชุฎุชูู ูู ุงูู **JSON Structure** โ ููุงุฒู ุชุทุงุจูู ูุน ุงููุซุงุฆู ุงูุฑุณููุฉ ุจุชุงุนุชูู.
* ุบุงูุจูุง ุจูุจุนุชูุง **Signature Header** ุฒู:

  ```
  X-Signature: HMACSHA256(payload, secret)
  ```

  โ ุณุงุนุชูุง ุงูุช ุชุชุญูู ููู ูุจู ูุง ุชุญุฏุซ ุฃู ุจูุงูุงุช ูู ุงูุณูุณุชู.

---


ุฅุฒุงู ุชุถูู ุงู Signature Verification ูู ุงูููุฏ ุจุญูุซ ุชุชุฃูุฏ ุฅู ุงูุฑูููุณุช ุฌุงู ูุนููุง ูู ุจูุงุจุฉ ุงูุฏูุน ูุด ูู ุฃู ุญุฏ ุชุงููุ ูุฏู ุงูููุทุฉ ุงูุฃูู ูู ููุถูุน ุงูู **Webhook Security**. ูุฃู ุฃู ุญุฏ ูููู ูุนุฑู ุงูู endpoint ุจุชุงุนู ููุญุงูู ูุจุนุชู ุฑูููุณุช ูุฒูู ูุบููุฑ ุญุงูุฉ ุงูุทูุจ.

---

## ุงูููุฑุฉ ุงูุฃุณุงุณูุฉ

1. ุจูุงุจุฉ ุงูุฏูุน ุจุชุจุนุชูู **Body** (ุงูู JSON).
2. ูุนุงูุง ุชุจุนุชูู **Header** ููู ุชูููุน (Signature).
3. ุงูุชูููุน ุฏู ูุนููู ุจุงุณุชุฎุฏุงู ุฎูุงุฑุฒููุฉ ุฒู **HMAC-SHA256** ุจุงูู **Secret Key** ุงููู ุฃูุช ูุงุฎุฏู ูููู.
4. ุงูุช ุชุนูุฏ ุญุณุงุจ ุงูุชูููุน ุจููุณู โ ูุชูุงุฑู ูุน ุงููู ุฌุงูู ูู ุงููHeader.

   * ูู ูุชุทุงุจู โ โ ูุจูู ุงูุฑูููุณุช ุตุญูุญ.
   * ูู ูุฎุชูู โ โ ุชุฑูุถ ุงูุฑูููุณุช.

---

## ูุซุงู ุนููู ูู ASP.NET Core

```csharp
using Microsoft.AspNetCore.Mvc;
using System.Security.Cryptography;
using System.Text;

namespace PaymentIntegrationDemo.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class PaymentWebhookController : ControllerBase
    {
        private const string SecretKey = "your-secret-key-from-gateway";

        [HttpPost("callback")]
        public async Task<IActionResult> PaymentCallback()
        {
            // Read raw body
            using var reader = new StreamReader(Request.Body);
            var body = await reader.ReadToEndAsync();

            // Get signature from headers (example: X-Signature)
            var signatureHeader = Request.Headers["X-Signature"].FirstOrDefault();

            if (!VerifySignature(body, signatureHeader))
            {
                return Unauthorized(new { message = "Invalid signature" });
            }

            // Deserialize JSON body
            var request = System.Text.Json.JsonSerializer.Deserialize<PaymentWebhookRequest>(body);

            if (request.Status == "paid")
            {
                Console.WriteLine($"โ Order {request.OrderId} paid successfully!");
                // TODO: Update DB (mark order as paid)
            }
            else
            {
                Console.WriteLine($"โ Payment failed for Order {request.OrderId}");
                // TODO: Handle failed payment
            }

            return Ok(new { message = "Webhook received successfully" });
        }

        private bool VerifySignature(string body, string? signatureHeader)
        {
            if (string.IsNullOrEmpty(signatureHeader))
                return false;

            using var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(SecretKey));
            var hash = hmac.ComputeHash(Encoding.UTF8.GetBytes(body));
            var computedSignature = Convert.ToHexString(hash).ToLower();

            return computedSignature == signatureHeader.ToLower();
        }
    }

    public class PaymentWebhookRequest
    {
        public string TransactionId { get; set; }
        public string OrderId { get; set; }
        public string Status { get; set; }
        public decimal Amount { get; set; }
    }
}
```

---

##  ุดุฑุญ ุณุฑูุน ููููุฏ

* ุงู `SecretKey`: ุฏู ุงูู secret ุงููู ุจูุงุจุฉ ุงูุฏูุน ุจุชุฏูููู.
* ุงู `VerifySignature`: ุจุชุญุณุจ HMAC-SHA256 ูู ุงูู body ูุชูุงุฑูู ุจุงููู ูู ุงููHeader.
* ูู ุงููSignature ุตุญูุญ โ ุชูููู ูุชุนูู Update ูู DB.
* ูู ุบูุท โ ุจุชุฑุฌุน `401 Unauthorized`.

---

##  ุณุคุงู ูุชููุน ูู ุงูุฅูุชุฑููู

**ุณ: ุฅุฒุงู ุชุถูู ุฃูุงู ุงููWebhookุ**
ุฌ: ุนู ุทุฑูู ุงูุชุญูู ูู ุงูุชูููุน (Signature Verification) ุจุงุณุชุฎุฏุงู HMAC ูุงูู Secret Keyุ ูููุงู ุจุชุณูุญ ููุท ูุจูุงุจุฉ ุงูุฏูุน ุจุงููุตูู (ูููู ุฃููุชุฑ ุจุงูู IPs (ุงูุงูุจููุงุช ูุนูู) ูู ุงูุดุฑูุฉ ุจุชุฏู ุฑููุฌ ูุนูู).

---

* ุฃู Request ุจููุตูู ุนูู ุงูุณูุฑูุฑ ูุงุฒู ูููู ุฌุงู ูู ุนููุงู ุฅูุชุฑูุช (IP Address).
* ุจูุงุจุฉ ุงูุฏูุน ุนูุฏูุง **ุณูุฑูุฑุงุช ูุญุฏุฏุฉ** ูู ุงููู ูุชุจุนุชูู ุงูู Webhook.
* ุงูุดุฑูุงุช ุงููุจูุฑุฉ ุฒู **Stripe / PayPal / Paymob** ุณุงุนุงุช ุจุชูุดุฑ **ูุงุฆูุฉ ุจุงูู IP ranges** ุงููู ุงูุฑูููุณุชุงุช ูุชูุฌู ูููุง.

---

## ุฅุฒุงู ุชุณุชุฎุฏู ุงูู IPs ูู ุงูุฃูุงูุ

* ููุง ููุตูู Webhook โ ูุจู ูุง ุชุนุงูุฌู โ ุชุดูู **IP ุจุชุงุน ุงููุฑุณู**.
* ูู ุงููIP ูุด ูู ุถูู ุงููุงุฆูุฉ ุงูููุซููุฉ ุงููู ุงูุจูุงุจุฉ ุฃุนููุชูุง โ ุจุฑูุถู ููุฑูุง .

---

## ูุซุงู ุนููู ูู ASP.NET Core

```csharp
using Microsoft.AspNetCore.Mvc;

namespace PaymentIntegrationDemo.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class PaymentWebhookController : ControllerBase
    {
        private static readonly string[] AllowedIps = new[]
        {
            "52.11.22.33",    // Example: Gateway IP
            "34.210.55.120"   // Example: Another Gateway IP
        };

        [HttpPost("callback")]
        public IActionResult PaymentCallback([FromBody] PaymentWebhookRequest request)
        {
            var remoteIp = HttpContext.Connection.RemoteIpAddress?.ToString();

            if (!AllowedIps.Contains(remoteIp))
            {
                return Unauthorized(new { message = "Unauthorized IP address" });
            }

            // TODO: Verify signature + process payment
            return Ok(new { message = "Webhook received successfully" });
        }
    }

    public class PaymentWebhookRequest
    {
        public string TransactionId { get; set; }
        public string OrderId { get; set; }
        public string Status { get; set; }
        public decimal Amount { get; set; }
    }
}
```

---

## ุณุคุงู ุฅูุชุฑููู ูุชููุน

**ุณ: ููู ูููู ุชุญุชุงุฌ ุชุนูู IP Filtering ููู Webhookุ**

* ุนุดุงู ุชุฒูุฏ ุทุจูุฉ ุฃูุงู ุฅุถุงููุฉ. ุญุชู ูู ุญุฏ ุนุฑู ุงูู Secret ุฃู ุญุงูู ูุจุนุซ Request ูุฒููุ ูุด ูููุฏุฑ ููุตู ุฅูุง ูู ุฌุงู ูู IP ูุณููุญ ุจูู ุชุงุจุน ูุจูุงุจุฉ ุงูุฏูุน.

---

 ูุฏู ุนูุฏู ุฎุท ุฏูุงุน ูุฒุฏูุฌ:

 ุงู **Signature Verification (HMAC)**
 ูุงู **IP Whitelisting**

ูู ุงูุงุชููู ุตุญ โ ุงูุฑูููุณุช ุณููู.
ูู ูุงุญุฏ ูููู ูุดู โ ุชุฑูุถ.

---

## ูุซุงู 1. **Paymob (ุจูุงุจุฉ ุฏูุน ูุตุฑูุฉ ุดููุฑุฉ)**

### ุดูู Webhook ุจูุฌู ูู Paymob

ุจุนุฏ ูุง ุงูุนููู ูุฏูุนุ Paymob ุจุชุจุนุชูู JSON ูุฏู:

```json
{
  "id": 123456789,
  "amount_cents": 10000,
  "currency": "EGP",
  "order": {
    "id": 987654321,
    "merchant_order_id": "ORD123"
  },
  "success": true,
  "is_voided": false,
  "is_refunded": false,
  "created_at": "2025-09-09T14:30:00Z",
  "source_data": {
    "pan": "2346",
    "sub_type": "MasterCard",
    "type": "card"
  }
}
```

###  ุงูุฃูุงู ุนูุฏ Paymob

* ุจูุจุนุชูุง ูุน ุงูุฑูููุณุช **HMAC Signature** ูู Header.
* ุงูุช ูุงุฒู ุชุนูุฏ ุญุณุงุจ ุงูุชูููุน ุจููุณ ุงูุณุฑู ุงููู ุนูุฏู (Integration Key).
* ูู ูุชุทุงุจู โ โ ุชููู.

---

## ูุซุงู 2. **Stripe (ูุงุญุฏุฉ ูู ุฃุดูุฑ ุจูุงุจุงุช ุงูุฏูุน ุนุงููููุง)**

### ุดูู Webhook ุจูุฌู ูู Stripe

ุงู Stripe ุจุชุจุนุช Event ูุงููุ ูุซูุงู ุงูุฏูุน ูุฌุญ:

```json
{
  "id": "evt_1OzOdh2eZvKYlo2Cgk0c9hfd",
  "object": "event",
  "api_version": "2025-01-01",
  "created": 1725876340,
  "data": {
    "object": {
      "id": "pi_3OzOdG2eZvKYlo2C1vZjqk8Q",
      "object": "payment_intent",
      "amount": 10000,
      "currency": "usd",
      "status": "succeeded"
    }
  },
  "type": "payment_intent.succeeded"
}
```

### ุงูุฃูุงู ุนูุฏ Stripe

* ุจูุจุนุชูุง **Stripe-Signature Header**.
* ุงูุช ูุงุฒู ุชุณุชุฎุฏู ููุชุจุชูู ุฃู ููุฏ HMAC ููุชุญูู.
* ููุงู ุจูููููุง ุชูุฏุฑ ุชุญุฏุฏ **IP ranges** ุงูุฎุงุตุฉ ุจุณูุฑูุฑุงุชูู ูู ุนุงูุฒ Double Security.

---

## ุงููุฑู ุจูู Paymob ู Stripe

| ุงูุนูุตุฑ              | Paymob                                | Stripe                             |
| ------------------- | ------------------------------------- | ---------------------------------- |
| **ุงูููุงู**          | ูุตุฑ / MENA                            | ุนุงููู                              |
| **ุงูุนููุฉ ุงูุฃุณุงุณูุฉ** | EGP                                   | USD + ูู ุงูุนููุงุช                   |
| **ุงููWebhook**      | JSON ุจุณูุท ูุน HMAC                     | JSON ูุน Event ูุงูู + ุชูููุน         |
| **ุงูุฃูุงู**          | HMAC Signature                        | Signature + IP Filtering           |
| **ุงุณุชุฎุฏุงู ุนููู**    | ููุงุณุจ ููุณูู ุงููุตุฑู (ููุฒุง/ูุงุณุชุฑ ูุญููุฉ) | ุนุงููู ูุน ุจุทุงูุงุช ูุฃุจู ุจุงู ูุฌูุฌู ุจุงู |

---

## ุณุคุงู ุฅูุชุฑููู ูุชููุน

**ุณ: ูู ุงูุนููู ุฏูุน ุงููููุณ ุจุณ ุงููุช ูุทุน ุนูุฏู ูุจู ูุง ูุฑุฌุน ููู Redirect URLุ ุฅุฒุงู ุชุนุฑู ุฅู ุงููููุณ ุฏุฎูุชุ**
ุฌ: ุนู ุทุฑูู ุงูู Webhook. ุงูุจูุงุจุฉ ูุชุจุนุชูู ุฅุดุนุงุฑ ุฑุณูู ุฅู ุญุงูุฉ ุงูุนูููุฉ = paid ุญุชู ูู ุงูุนููู ูุง ุฑุฌุนุด ููุตูุญุฉ.


---

## ๐ 1. ุดูู JSON ูู Paymob (Webhook Event)

ูุซุงู ูุจุณุท:

```json
{
  "id": 123456789,
  "amount_cents": 10000,
  "currency": "EGP",
  "order": {
    "id": 987654321,
    "merchant_order_id": "ORD123"
  },
  "success": true,
  "is_voided": false,
  "is_refunded": false,
  "created_at": "2025-09-09T14:30:00Z",
  "source_data": {
    "pan": "2346",
    "sub_type": "MasterCard",
    "type": "card"
  }
}
```

---

## ๐ 2. ุงูููุฏ ูู ASP.NET Core

```csharp
using Microsoft.AspNetCore.Mvc;
using System.Security.Cryptography;
using System.Text;
using System.Text.Json;

namespace PaymentIntegrationDemo.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class PaymobWebhookController : ControllerBase
    {
        private const string SecretKey = "YOUR_PAYMOB_HMAC_SECRET";

        [HttpPost("callback")]
        public async Task<IActionResult> Callback()
        {
            // Read raw body (JSON)
            using var reader = new StreamReader(Request.Body);
            var body = await reader.ReadToEndAsync();

            // Get HMAC signature from headers
            var signature = Request.Headers["hmac"].FirstOrDefault();

            if (!VerifyHmac(body, signature))
            {
                return Unauthorized(new { message = "Invalid HMAC signature" });
            }

            // Deserialize JSON
            var request = JsonSerializer.Deserialize<PaymobWebhookRequest>(body);

            if (request.Success)
            {
                Console.WriteLine($"โ Order {request.Order.MerchantOrderId} paid successfully!");
                // TODO: Update order status in DB
            }
            else
            {
                Console.WriteLine($"โ Payment failed for Order {request.Order.MerchantOrderId}");
                // TODO: Handle failed payment
            }

            return Ok(new { message = "Webhook received" });
        }

        private bool VerifyHmac(string body, string? receivedSignature)
        {
            if (string.IsNullOrEmpty(receivedSignature))
                return false;

            using var hmac = new HMACSHA512(Encoding.UTF8.GetBytes(SecretKey));
            var hash = hmac.ComputeHash(Encoding.UTF8.GetBytes(body));
            var computedSignature = BitConverter.ToString(hash).Replace("-", "").ToLower();

            return computedSignature == receivedSignature.ToLower();
        }
    }

    // Map Paymob Webhook JSON
    public class PaymobWebhookRequest
    {
        public long Id { get; set; }
        public int Amount_Cents { get; set; }
        public string Currency { get; set; }
        public PaymobOrder Order { get; set; }
        public bool Success { get; set; }
        public bool Is_Voided { get; set; }
        public bool Is_Refunded { get; set; }
        public DateTime Created_At { get; set; }
        public SourceData Source_Data { get; set; }
    }

    public class PaymobOrder
    {
        public long Id { get; set; }
        public string MerchantOrderId { get; set; }
    }

    public class SourceData
    {
        public string Pan { get; set; }
        public string Sub_Type { get; set; }
        public string Type { get; set; }
    }
}
```

---

## ๐ 3. ุงูููุงุญุธุงุช ุงููููุฉ

* ูุงุฒู ุชุฌูุจ ุงูู **HMAC Secret Key** ูู Paymob Dashboard.
* ุงู Paymob ุจูุจุนุช ุงูู HMAC ูู Header ุงุณูู `hmac`.
* ุงุณุชุฎุฏู ููุณ ุงูู Algorithm ุงููู Paymob ุจุชููู ุนููู (ูู Docs ุจุชุงุนุชูู ุฃุบูุจ ุงูููุช HMAC-SHA512).
* ุจุนุฏ ูุง ุชุชุญูู ูู ุงูุชูููุน ูุชุนูู Deserialize โ ุญุฏูุซ ุงูุทูุจ ูู ุงููDB.

---

## ุณุคุงู ุฅูุชุฑููู ูุชููุน

**ุณ: ุฅุฒุงู ุชูุฏุฑ ุชุชุฃูุฏ ุฅู ุงูู Webhook ุงููู ุฌุงูู ูู Paymob ูุด Fakeุ**

* ุฃุฑุฏ:

  1. ุฃุชุญูู ูู HMAC Signature ุจุงุณุชุฎุฏุงู ุงูู Secret Key.
  2. ุฃููุชุฑ ุงูู IPs (ูู Paymob ูุดุฑุช ุฑููุฌ IPs).
  3. ุฃุณุฌู ูู Webhook ููู Auditing ุนุดุงู ุฃูุฏุฑ ุฃุฑุงุฌุน ุจุนุฏูู.
