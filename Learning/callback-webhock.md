
## ğŸ¤ Ø±Ø¯Ùƒ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ±ÙÙŠÙˆ (Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ)

> "Ø£ÙŠÙˆØ© Ø·Ø¨Ø¹Ù‹Ø§ØŒ Ø¨ÙˆØ§Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø¨ÙŠØ¨Ù‚Ù‰ Ù„ÙŠÙ‡Ø§ ÙƒØ°Ø§ Ø·Ø±ÙŠÙ‚Ø© Ù„Ù„Ù€ Integration Ø¹Ù„Ù‰ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ¯Ø±Ø¬Ø© Ø§Ù„Ù€ control Ø§Ù„Ù„ÙŠ Ø¹Ø§ÙŠØ²Ù‡Ø§. ØºØ§Ù„Ø¨Ù‹Ø§ Ø§Ù„Ø·Ø±Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© 3:

 1.Ø§Ù„  **Hosted Payment Page (Redirect Integration):**
    Ø¯ÙŠ Ø£Ø¨Ø³Ø· Ø·Ø±ÙŠÙ‚Ø©ØŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØªØ­ÙˆÙ„ Ù„ØµÙØ­Ø© Ø¬Ø§Ù‡Ø²Ø© Ù…Ù† Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ØŒ ÙŠØ¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ø±Øª Ù‡Ù†Ø§ÙƒØŒ ÙˆØ¨Ø¹Ø¯ ÙƒØ¯Ù‡ Ø¨ÙŠØªØ­ÙˆÙ„ ÙŠØ±Ø¬Ø¹ Ø¹Ù†Ø¯ÙŠ ÙÙŠ Success Ø£Ùˆ Fail URL.
    Ù…ÙŠØ²Ø© Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø¯ÙŠ Ø¥Ù†Ù‡Ø§ Ø¢Ù…Ù†Ø© Ø¬Ø¯Ù‹Ø§ Ù„Ø£Ù† ÙƒÙ„ Ø­Ø§Ø¬Ø© Ø¨ØªØ­ØµÙ„ Ø¹Ù†Ø¯ Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø©.
>
 2.Ø§Ù„  **Embedded Checkout (iFrame/JS SDK):**
    Ù‡Ù†Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (form) Ø¨ØªØ§Ø¹ Ø§Ù„Ø¯ÙØ¹ Ø¨ÙŠØ¸Ù‡Ø± Ø¬ÙˆØ§ Ù…ÙˆÙ‚Ø¹ÙŠ Ø¹Ù† Ø·Ø±ÙŠÙ‚ iFrame Ø£Ùˆ JavaScript SDK.
    ÙƒØ¯Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙŠÙØ¶Ù„ ÙÙŠ Ù…ÙˆÙ‚Ø¹ÙŠØŒ Ù„ÙƒÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø¨ØªØªØ¨Ø¹Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ù€ Gateway.
    Ø¯ÙŠ Ø¨ØªØ¯ÙŠ User Experience Ø£Ø­Ø³Ù† Ø´ÙˆÙŠØ©ØŒ ÙˆÙ„Ø³Ù‡ Ø¢Ù…Ù†Ø©.
>
 3.Ø§Ù„  **Direct API Integration (Server-to-Server):**
    Ù‡Ù†Ø§ Ø£Ù†Ø§ Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ù…Ù„ Collect Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ£Ø¨Ø¹ØªÙ‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ù€ Payment Gateway API.
    Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø¯ÙŠ Ø¨ØªØ¯ÙŠÙ†ÙŠ Full Control ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø¨Ø³ Ø£Ù†Ø§ Ø§Ù„Ù„ÙŠ Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ø£Ù…Ø§Ù† Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ (Ø²ÙŠ PCI DSS compliance).
    ØºØ§Ù„Ø¨Ù‹Ø§ Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø£Ùˆ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù‡ÙŠ Ø§Ù„Ù„ÙŠ Ø¨ØªØ­ØªØ§Ø¬Ù‡Ø§."

---

## ğŸŸ¢ Ø§Ù„ØªÙˆØ¶ÙŠØ­ Ø£ÙƒØªØ± Ù„Ùƒ (Ø¹Ø´Ø§Ù† ØªÙÙ‡Ù…Ù‡Ø§ Ø¨Ø¹Ù…Ù‚):

Ø§ÙˆÙ„Ø§  **Redirect (Hosted Page):**

   * Ø²ÙŠ Ù…Ø§ PayPal Ùˆ Fawry Ø¨ÙŠØ¹Ù…Ù„ÙˆØ§.
   * Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØªÙˆØ¬Ù‡ Ø¨Ø±Ø© Ø¹Ù†Ø¯Ù‡Ù…ØŒ ÙŠØ¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡ØŒ ÙŠØ±Ø¬Ø¹Ù„Ùƒ.
   * Ø£ÙƒØªØ± Ø­Ø§Ø¬Ø© Ø£Ù…Ø§Ù† ÙˆØ£Ù‚Ù„ ØµØ¯Ø§Ø¹.

Ø«Ø§Ù†ÙŠØ§ **iFrame/Widget/JS Plugin:**

   * Ø²ÙŠ Fawaterk plugin Ø§Ù„Ù„ÙŠ Ø£Ù†Øª Ù„Ø³Ù‡ ÙƒÙ†Øª Ø¨ØªØ¬Ø±Ø¨Ù‡.
   * Ø¨ÙŠØ¹Ø±Ø¶Ù„Ùƒ Ø§Ù„Ù€ checkout Ø¬ÙˆØ§ ØµÙØ­ØªÙƒ.
   * Ø¨ÙŠØ¯ÙŠÙƒ Ù…Ø±ÙˆÙ†Ø© ÙÙŠ Ø§Ù„ØªØµÙ…ÙŠÙ… + ØªØ¬Ø±Ø¨Ø© Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø­Ø³Ù†.

Ø«Ø§Ù„Ø«Ø§ **Direct API:**

   * Ø£Ù†Øª ØªØ¨Ù†ÙŠ UI Ø¨ØªØ§Ø¹Ùƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.
   * ØªØ¨Ø¹Øª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ±ÙˆØª Ø£Ùˆ Ø§Ù„ØªÙˆÙƒÙŠÙ† Ù„Ù„Ù€ Gateway.
   * Ù…Ø­ØªØ§Ø¬Ø© Ø´Ù‡Ø§Ø¯Ø§Øª Ø£Ù…Ø§Ù† (PCI DSS) ÙˆØªØ´ÙÙŠØ±.
   * Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù„ÙŠ Ø¹Ø§ÙŠØ²Ø© Full control (Ø²ÙŠ Uber Ø£Ùˆ Amazon).

---

## ğŸ“ Ø§Ù„Ø®Ù„Ø§ØµØ© Ø§Ù„Ù„ÙŠ ØªÙ‚ÙˆÙ„Ù‡Ø§ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ±ÙÙŠÙˆ:

> "Ø§Ù„Ù€ integration Ù…Ù…ÙƒÙ† ÙŠØªØ¹Ù…Ù„ Ø¨Ø«Ù„Ø§Ø« Ø·Ø±Ù‚ Ø±Ø¦ÙŠØ³ÙŠØ©: Redirect Ù„ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹ØŒ Embedded iFrame/JS SDKØŒ Ø£Ùˆ Direct API Integration. ÙƒÙ„ Ø·Ø±ÙŠÙ‚Ø© Ù„ÙŠÙ‡Ø§ Ù…Ù…ÙŠØ²Ø§Øª ÙˆØ¹ÙŠÙˆØ¨ØŒ ÙˆØ§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¨ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø­Ø¬Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆÙ…ØªØ·Ù„Ø¨Ø§ØªÙ‡ Ù…Ù† Ø­ÙŠØ« Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…."

---

## ğŸ”¹ 1. ÙŠØ¹Ù†ÙŠ Ø¥ÙŠÙ‡ SDKØŸ

**SDK = Software Development Kit**

* Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† **Ø£Ø¯ÙˆØ§Øª + Ù…ÙƒØªØ¨Ø§Øª + Documentation** Ø¨ÙŠÙ‚Ø¯Ù…Ù‡Ø§Ù„Ùƒ Ù…Ø²ÙˆØ¯ Ø§Ù„Ø®Ø¯Ù…Ø© (Ø²ÙŠ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹) Ø¹Ø´Ø§Ù† ØªØ³Ù‡Ù„ Ø¹Ù„ÙŠÙƒ Ø§Ù„ØªÙƒØ§Ù…Ù„ Ù…Ø¹Ø§Ù‡.
* Ø¨Ø¯Ù„ Ù…Ø§ ØªÙƒØªØ¨ ÙƒÙ„ Ø­Ø§Ø¬Ø© Ù…Ù† Ø§Ù„ØµÙØ±ØŒ Ù‡Ùˆ Ø¨ÙŠØ¯ÙŠÙƒ SDK Ø¬Ø§Ù‡Ø²: Ù…Ù…ÙƒÙ† ÙŠÙƒÙˆÙ† JavaScript SDK (Ù„Ù„Ù…ØªØµÙØ­)ØŒ Ø£Ùˆ SDK Ù„Ù„Ù€ .NET Ø£Ùˆ Java Ø£Ùˆ Python.

**Ù…Ø«Ø§Ù„:**
Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªØ¯Ù…Ø¬ PayPal ÙÙŠ Ù…ÙˆÙ‚Ø¹ÙƒØŒ Ù…Ø´ Ù„Ø§Ø²Ù… ØªØ¹ÙŠØ¯ Ø§Ø®ØªØ±Ø§Ø¹ Ø§Ù„Ø¹Ø¬Ù„Ø© ÙˆØªÙƒØªØ¨ ÙƒÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠ ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù€ APIs.
Ù‡Ù… Ø¨ÙŠØ¯ÙˆÙƒ JavaScript SDK ØªÙƒØªØ¨Ù‡ Ø¨Ø³ ÙƒØ¯Ù‡:

```html
<script src="https://www.paypal.com/sdk/js?client-id=YOUR_CLIENT_ID"></script>
```

ÙˆÙ‡Ùˆ Ø¬Ø§Ù‡Ø² ÙŠØ¯ÙŠØ±Ù„Ùƒ Ø²Ø±Ø§Ø± Ø§Ù„Ø¯ÙØ¹ ÙˆÙƒÙ„ Ø§Ù„Ù„ÙŠ ÙˆØ±Ø§Ù‡.

Ø§Ù„ SDK ÙŠØ¹Ù†ÙŠ = "ØµÙ†Ø¯ÙˆÙ‚ Ø£Ø¯ÙˆØ§Øª" Ø¬Ø§Ù‡Ø² ÙŠØ³Ù‡Ù‘Ù„Ù„Ùƒ Ø§Ù„Ø§Ù†ØªØ¬Ø±ÙŠØ´Ù†.

---

## ğŸ”¹ 2. ÙŠØ¹Ù†ÙŠ Ø¥ÙŠÙ‡ PCI DSS ComplianceØŸ

Ø§Ù„ **PCI DSS = Payment Card Industry Data Security Standard**

* Ø¯Ù‡ **Ù…Ø¹ÙŠØ§Ø± Ø¹Ø§Ù„Ù…ÙŠ Ù„Ù„Ø£Ù…Ø§Ù†** Ø¨ÙŠØªÙØ±Ø¶ Ø¹Ù„Ù‰ Ø£ÙŠ Ø´Ø±ÙƒØ© Ø¨ØªØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ±ÙˆØª Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù†.
* Ø§ØªØ¹Ù…Ù„ Ù…Ù† Ø´Ø±ÙƒØ§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© (Visa, MasterCard, American Express).
* Ø¨ÙŠÙ‚ÙˆÙ„Ùƒ: Ù„Ùˆ Ù‡ØªØ®Ø²Ù† Ø£Ùˆ ØªØ¹Ø§Ù„Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ø±Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù†Ø¯ÙƒØŒ Ù„Ø§Ø²Ù… ØªÙ„ØªØ²Ù… Ø¨Ù…Ø¹Ø§ÙŠÙŠØ± ØµØ§Ø±Ù…Ø© Ø²ÙŠ:

  * ÙƒÙ„ Ø§Ù„Ø¯Ø§ØªØ§ Ù…ØªØ´ÙØ±Ø©.
  * Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª Ù…Ø¹Ù…ÙˆÙ„Ø© Ù„Ù‡Ø§ Firewall Ù‚ÙˆÙŠ.
  * ÙÙŠ Monitoring logs Ø¯Ø§Ø¦Ù….
  * Ù…ÙÙŠØ´ Access Ø¹Ø´ÙˆØ§Ø¦ÙŠ.
  * Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Penetration Testing Ø¨Ø§Ø³ØªÙ…Ø±Ø§Ø±.

**Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ:**

* Ù„Ùˆ Ù‡ØªØ¹Ù…Ù„ Direct API Integration ÙˆØªØ¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ±ÙˆØª Ø¹Ù†Ø¯ÙƒØŒ Ù„Ø§Ø²Ù… Ø´Ø±ÙƒØªÙƒ ØªØ§Ø®Ø¯ Ø´Ù‡Ø§Ø¯Ø© PCI DSS.
* Ø¹Ø´Ø§Ù† ÙƒØ¯Ù‡ Ù…Ø¹Ø¸Ù… Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„ØµØºÙŠØ±Ø© ÙˆØ§Ù„Ù…ØªÙˆØ³Ø·Ø© **ØªÙ‡Ø±Ø¨ Ù…Ù† Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø¯ÙŠ** ÙˆØªØ³ØªØ®Ø¯Ù… Redirect Ø£Ùˆ iFrameØŒ Ù„Ø£Ù† Ø§Ù„Ù€ Gateway Ù†ÙØ³Ù‡ Ù‡Ùˆ Ø§Ù„Ù„ÙŠ compliant ÙˆØ£Ù†Øª ÙÙŠ Ø§Ù„Ø£Ù…Ø§Ù†.

---

## ğŸ¤ Ø¥Ø²Ø§ÙŠ ØªÙ‚ÙˆÙ„Ù‡Ø§ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ±ÙÙŠÙˆ:

> Ø§Ù„ "SDK Ù‡Ùˆ Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† Ù…ÙƒØªØ¨Ø§Øª ÙˆØ£Ø¯ÙˆØ§Øª Ø¬Ø§Ù‡Ø²Ø© Ø¨ÙŠØ¯ÙŠÙ‡Ø§Ù„ÙŠ Ù…Ø²ÙˆØ¯ Ø§Ù„Ø¯ÙØ¹ Ø¹Ø´Ø§Ù† Ø£Ù‚Ø¯Ø± Ø£Ø¹Ù…Ù„ Integration Ø¨Ø³Ù‡ÙˆÙ„Ø©ØŒ Ø²ÙŠ JavaScript SDK Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ¹Ø±Ø¶ Ø²Ø±Ø§Ø± Ø¯ÙØ¹ Ø£Ùˆ Checkout form.
>
> ÙˆØ¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù€ PCI DSSØŒ Ø¯Ù‡ Ù…Ø¹ÙŠØ§Ø± Ø¹Ø§Ù„Ù…ÙŠ Ù„Ù„Ø£Ù…Ø§Ù† Ø®Ø§Øµ Ø¨Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¯ÙØ¹ØŒ Ø£ÙŠ Ø´Ø±ÙƒØ© Ø¨ØªØ®Ø²Ù† Ø£Ùˆ ØªØ¹Ø§Ù„Ø¬ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù„Ø§Ø²Ù… ØªÙ„ØªØ²Ù… Ø¨ÙŠÙ‡. Ø¹Ø´Ø§Ù† ÙƒØ¯Ù‡ Direct API Integration Ø¨ÙŠÙƒÙˆÙ† Ø£ØµØ¹Ø¨ Ø´ÙˆÙŠØ© Ù„Ø£Ù†Ù‡ Ø¨ÙŠØ®Ù„ÙŠÙ†ÙŠ Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ù€ complianceØŒ Ø¹ÙƒØ³ Ø§Ù„Ø·Ø±Ù‚ Ø§Ù„ØªØ§Ù†ÙŠØ© Ø§Ù„Ù„ÙŠ Ø¨ØªØ­Ù…Ù„ Ø§Ù„Ø¹Ø¨Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ù€ gateway Ù†ÙØ³Ù‡."

---


## 4ï¸âƒ£ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù€ Payment Integration

Ø§ 1. **Hosted Payment Page (Redirect)**

   * Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨ÙŠØªØ­ÙˆÙ‘Ù„ Ø¹Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹ Ø¨ØªØ§Ø¹Ø© Ø§Ù„Ù€ Gateway (Ø²ÙŠ PayPal, Fawry).
   * Ù…Ù…ÙŠØ²Ø§ØªÙ‡Ø§: Ø³Ù‡Ù„Ø© ÙˆÙ…Ø£Ù…ÙˆÙ†Ø©.
   * Ø¹ÙŠØ¨Ù‡Ø§: ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ØªØ·Ù„Ø¹ Ø¨Ø±Ù‡ Ù…ÙˆÙ‚Ø¹Ùƒ.

Ø§ 2. **Embedded Form / iFrame**

   * ÙÙˆØ±Ù… Ù…Ù† Ø§Ù„Ù€ Gateway ÙŠØªØ¹Ø±Ø¶ Ø¬ÙˆØ© Ù…ÙˆÙ‚Ø¹Ùƒ.
   * Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø´ Ø¨ÙŠØ³ÙŠØ¨ Ù…ÙˆÙ‚Ø¹Ùƒ.
   * Ø£Ù…Ø§Ù† Ù…ØªÙˆØ³Ø· (Ø£Ù†Øª Ù…Ø´ Ø¨ØªØ®Ø²Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ø±ØªØŒ Ø¨Ø³ Ø¨ØªØ¹Ø±Ø¶Ù‡Ø§).

Ø§ 3. **Direct API Integration**

   * Ù…ÙˆÙ‚Ø¹Ùƒ ÙŠØ§Ø®Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ø±Øª ÙˆÙŠØ¨Ø¹ØªÙ‡Ø§ Ù„Ù„Ù€ Gateway API.
   * Ù…Ø­ØªØ§Ø¬ PCI DSS compliance (Ù…Ø³Ø¤ÙˆÙ„ÙŠØ© Ø£Ø¹Ù„Ù‰).
   * Ø¨ØªØ­ÙƒÙ… Ø£ÙƒØªØ± ÙÙŠ ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….

---
## ÙÙŠ Challenges Ø¨ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø§Ù†ØªØ±ÙÙŠÙˆ

* **Ø§Ù„Ø£Ù…Ø§Ù†**: Ù„ÙŠÙ‡ Ù…Ù†Ø®Ø²Ù†Ø´ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ø±ØªØŸ (Ø¹Ù„Ø´Ø§Ù† PCI DSS).
* Ø§ **Handling Failures**: Ù„Ùˆ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙØ´Ù„Øª (declined) Ø¨ØªØ¹Ù…Ù„ retry Ø¥Ø²Ø§ÙŠØŸ
* Ø§ **Idempotency**: Ø¥Ø²Ø§ÙŠ ØªÙ…Ù†Ø¹ double paymentØŸ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… transaction id).
* Ø§ **Refunds/Chargebacks**: Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ†Ù‡Ù….
* Ø§ **Currency Conversion**: Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ multi-currency.
* Ø§ **Recurring Payments**: Ø¥Ø²Ø§ÙŠ ØªØ¹Ù…Ù„ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø¨Ø¯ÙˆÙ† Ù…Ø§ ØªØ¹ÙŠØ¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒØ§Ø±ØªØŸ (Tokenization).

---

## 8ï¸âƒ£ Ø¥Ø¬Ø§Ø¨Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ù…Ù…ÙƒÙ† ØªÙŠØ¬ÙŠ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ±ÙÙŠÙˆ

- *Ù„ÙŠÙ‡ Ø¨Ù†Ø³ØªØ®Ø¯Ù… Payment GatewayØŸ*
> Ø¹Ù„Ø´Ø§Ù† ÙŠÙˆÙØ± Ø£Ù…Ø§Ù† (Encryption, PCI DSS)ØŒ ÙŠØ³Ù‡Ù„ Ø§Ù„Ø¯Ù…Ø¬ (API/SDK)ØŒ ÙˆÙŠØ¹Ù…Ù„ ÙƒÙˆØ³ÙŠØ· Ø¨ÙŠÙ† Ø§Ù„ØªØ§Ø¬Ø± ÙˆØ§Ù„Ø¨Ù†ÙˆÙƒ.

- *Ø¥ÙŠÙ‡ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Authorization Ùˆ CaptureØŸ*
> Ø§ Authorization Ø¨ÙŠØ¹Ù…Ù„ hold Ù„Ù„ÙÙ„ÙˆØ³. Capture Ø¨ÙŠØ®ØµÙ…Ù‡Ø§ ÙØ¹Ù„ÙŠÙ‹Ø§.

- *Ø¥ÙŠÙ‡ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Refund Ùˆ ChargebackØŸ*
> Ø§ Refund Ø¨ÙŠØ±Ø¬Ù‘Ø¹ ÙÙ„ÙˆØ³ Ù…Ù† Ø§Ù„ØªØ§Ø¬Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„. Chargeback Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù†ÙØ³Ù‡ ÙŠØ¹ØªØ±Ø¶ Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ù†ÙƒØŒ ÙˆØ§Ù„Ø¨Ù†Ùƒ ÙŠØ³Ø­Ø¨ Ø§Ù„ÙÙ„ÙˆØ³ Ø¨Ø§Ù„Ù‚ÙˆØ©.

- *Ø¥ÙŠÙ‡ ÙÙˆØ§ÙŠØ¯ Ø§Ù„Ù€ TokenizationØŸ*
> Ø¨Ø¯Ù„ Ù…Ø§ ØªØ®Ø²Ù† card numberØŒ Ø¨ØªØ®Ø²Ù† token. Ø¯Ù‡ Ø¨ÙŠÙ‚Ù„Ù„ Ù…Ø®Ø§Ø·Ø± Ø§Ù„Ø§Ø®ØªØ±Ø§Ù‚.

- *Ø¥ÙŠÙ‡ ÙÙˆØ§ÙŠØ¯ WebhooksØŸ*
> ØªØ¹Ø±Ù ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ (success/fail/refund) Ù…Ù† ØºÙŠØ± Ù…Ø§ ØªØ¹ØªÙ…Ø¯ Ø¨Ø³ Ø¹Ù„Ù‰ response Ø£ÙˆÙ„ÙŠ.


---



Ø§Ù„Ù€ **Webhook** Ù‡Ùˆ ÙÙŠ Ø§Ù„Ø¢Ø®Ø± Ù…Ø¬Ø±Ø¯ **HTTP Request (Ø¹Ø§Ø¯Ø© POST)** Ø¨ÙŠØ¬ÙŠÙ„Ùƒ Ù…Ù† Ø§Ù„Ù€ Payment Gateway Ø¹Ù„Ù‰ Endpoint Ø¥Ù†Øª Ø¹Ø§Ù…Ù„Ù‡ Ø¹Ù†Ø¯Ùƒ ÙÙŠ Ø§Ù„Ù€ API.

### 1- Ø´ÙƒÙ„ Ø§Ù„Ù€ Request Ø¨ÙŠÙƒÙˆÙ† Ø¥Ø²Ø§ÙŠØŸ

* Ø¨ÙŠØ¬ÙŠÙ„Ùƒ **POST Request** Ø¹Ù„Ù‰ Ø§Ù„Ù€ URL Ø§Ù„Ù„ÙŠ Ø¥Ù†Øª Ù…Ø³Ø¬Ù„Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ù€ Gateway (Ù…Ø«Ù„Ø§Ù‹: `https://myapp.com/api/webhooks/payment`).
* Ø§Ù„Ù€ Body Ø¨ÙŠÙƒÙˆÙ† ØºØ§Ù„Ø¨Ù‹Ø§ **JSON** ÙÙŠÙ‡ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¯Ø« (Event) Ø§Ù„Ù„ÙŠ Ø­ØµÙ„ØŒ Ù…Ø«Ø§Ù„:

```json
{
  "id": "evt_12345",
  "type": "payment_success",
  "data": {
    "transactionId": "tx_98765",
    "amount": 5000,
    "currency": "USD",
    "status": "succeeded",
    "customerEmail": "user@example.com"
  }
}
```

Ù…Ù…ÙƒÙ† Ø§Ù„Ù†ÙˆØ¹ ÙŠÙƒÙˆÙ† Ù…Ø®ØªÙ„Ù Ø­Ø³Ø¨ Ø§Ù„Ù€ Gateway: Ø²ÙŠ `payment_failed`, `refund_issued`, Ø¥Ù„Ø®.

---

### 2- Ø¥Ø²Ø§ÙŠ Ø£ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø±ÙŠÙƒÙˆÙŠØ³Øª Ø¯Ù‡ Ø¬Ø§ÙŠ Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ØµØ­ Ù…Ø´ Ø­Ø¯ Ø¨ÙŠÙ‡ÙƒØ±Ù†ÙŠØŸ

ÙÙŠÙ‡ Ø·Ø±Ù‚ Ù…Ø®ØªÙ„ÙØ© ÙˆØ§Ù„Ù€ Gateways Ø¹Ø§Ø¯Ø© Ø¨ØªÙˆÙØ± ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ Ø£ÙƒØªØ±:

#### âœ… Ø£- **Secret Key / Signature Verification** (Ø§Ù„Ø£Ø´Ù‡Ø±):

* Ù…Ø¹ ÙƒÙ„ WebhookØŒ Ø§Ù„Ù€ Gateway Ø¨ÙŠØ¨Ø¹Øª Header ÙÙŠÙ‡ ØªÙˆÙ‚ÙŠØ¹ (Signature).
* Ø¥Ù†Øª Ø¨ØªØ§Ø®Ø¯ Ø§Ù„Ù€ Body Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ + Secret Key (Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ùƒ) ÙˆØªØ¹Ù…Ù„ Hash Ø¨Ù†ÙØ³ Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© (Ø¹Ø§Ø¯Ø© HMAC-SHA256).
* Ù„Ùˆ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù„ÙŠ Ø¥Ù†Øª Ø·Ù„Ø¹ØªÙ‡ = Ø§Ù„Ù„ÙŠ ÙÙŠ Ø§Ù„Ù€ Header â†’ ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø±ÙŠÙƒÙˆÙŠØ³Øª Ø£ØµÙ„ÙŠ.
* Ù…Ø«Ø§Ù„ Header Ù…Ù† Stripe:

  ```
  Stripe-Signature: t=1234567890,v1=abcdef123456
  ```

#### âœ… Ø¨- **IP Whitelisting**:

* Ø¨Ø¹Ø¶ Gateways Ø¨ØªÙ‚ÙˆÙ„Ùƒ: "Ø§Ù„Ù€ Webhook Ù‡ÙŠØ¬ÙŠÙ„Ùƒ Ù…Ù† IP ranges Ù…Ø¹ÙŠÙ†Ø©"ØŒ ÙØ¥Ù†Øª ØªØªØ­Ù‚Ù‚ Ø¥Ù† Ø§Ù„Ù€ Request Ø¬Ø§ÙŠ Ù…Ù† IP Ø¶Ù…Ù† Ø§Ù„Ù„ÙŠ Ù‚Ø§ÙŠÙ„ÙŠÙ† Ø¹Ù„ÙŠÙ‡.

#### âœ… Ø¬- **Basic Authentication / API Key in Header**:

* Ø£Ø­ÙŠØ§Ù†Ù‹Ø§ Ø¨ÙŠØ¨Ø¹ØªÙˆØ§ Ù…Ø¹ ÙƒÙ„ Webhook API Key Ø£Ùˆ Token ÙÙŠ Ø§Ù„Ù€ Header ÙˆØ¥Ù†Øª ØªØªØ­Ù‚Ù‚ Ø¥Ù†Ù‡ ØµØ­ÙŠØ­.

---

### 3- Ø¥Ø²Ø§ÙŠ ØªØªØ¹Ø§Ù…Ù„ Ø¹Ù…Ù„ÙŠÙ‹Ø§ØŸ

* ØªØ¹Ù…Ù„ Controller Ø£Ùˆ Endpoint Ù…Ø®ØµØµ Ø²ÙŠ:

```csharp
[ApiController]
[Route("api/webhooks")]
public class WebhookController : ControllerBase
{
    [HttpPost("payment")]
    public IActionResult HandlePaymentWebhook([FromBody] JsonElement payload)
    {
        // Step 1: Verify Signature (depends on gateway)
        var signature = Request.Headers["X-Signature"];
        bool isValid = VerifySignature(payload, signature);

        if (!isValid)
            return Unauthorized();

        // Step 2: Process Event
        var eventType = payload.GetProperty("type").GetString();
        if (eventType == "payment_success")
        {
            var transactionId = payload.GetProperty("data").GetProperty("transactionId").GetString();
            // Update Order status in DB
        }

        // Step 3: Return 200 OK Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ Gateway ÙŠØ¹Ø±Ù Ø¥Ù†Ùƒ Ø§Ø³ØªÙ‚Ø¨Ù„Øª Ø§Ù„Ø­Ø¯Ø«
        return Ok();
    }
}
```

---

### 4- Ù„ÙŠÙ‡ Webhook Ù…Ù‡Ù…ØŸ

Ù„Ø£Ù†Ù‡ Ø¨ÙŠØ­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù„ÙŠ Ø¥Ù†Øª Ø³Ø£Ù„Øª Ø¹Ù†Ù‡Ø§ Ù‚Ø¨Ù„ ÙƒØ¯Ù‡:
Ù„Ùˆ Ø§Ù„Ù†Øª Ù‚Ø·Ø¹ ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§ ÙˆØµÙ„Ø´ Ù„Ù€ Order Confirmation Page â†’ Ø§Ù„Ù€ Webhook Ù‡ÙŠÙˆØµÙ„Ùƒ Ùˆ ØªØ¹Ø±Ù Ø¥Ù† Ø§Ù„Ø¯ÙØ¹ ØªÙ… ÙˆØªØ­Ø¯Ø« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø´Ø§ÙØ´.

---


---

## ğŸŸ¢ Ø£ÙˆÙ„Ø§Ù‹: Ø§Ù„Ø±ÙŠÙƒÙˆØ³Øª Ø¨ÙŠØ¬ÙŠ Ø¥Ø²Ø§ÙŠØŸ

* Ø§Ù„Ù€ **Webhook** ÙÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ Ù…Ø¬Ø±Ø¯ **HTTP POST Request** Ø§Ù„Ø¬ÙŠØªÙˆØ§ÙŠ Ø¨ÙŠØ¨Ø¹ØªÙ„Ùƒ Ø¹Ù„Ù‰ URL Ø¥Ù†Øª Ù…Ø­Ø¯Ø¯Ù‡.
* Ø¨ÙŠØ¨Ø¹Øª ÙÙŠ Ø§Ù„Ù€ Body Ø¨ØªØ§Ø¹ Ø§Ù„Ø±ÙŠÙƒÙˆØ³Øª **JSON Payload** ÙÙŠÙ‡ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¯Ø« (Event).

### Ù…Ø«Ø§Ù„ Ø¹Ø§Ù… (JSON Ø¬Ø§ÙŠ Ù…Ù† Payment Gateway):

```json
{
  "event": "payment_succeeded",
  "transaction_id": "tx_123456789",
  "order_id": "ord_987654321",
  "amount": 5000,
  "currency": "EGP",
  "status": "succeeded",
  "timestamp": "2025-09-11T09:30:00Z"
}
```

* Ø§Ù„ `event` â†’ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø¯Ø« (Ù†Ø¬Ø§Ø­ØŒ ÙØ´Ù„ØŒ PendingØŒ Refundâ€¦).
* Ø§Ù„ `transaction_id` â†’ Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ù€ Gateway.
* Ø§Ù„ `order_id` â†’ Ø§Ù„Ø£ÙˆØ±Ø¯Ø± Ø¹Ù†Ø¯Ùƒ Ø§Ù„Ù„ÙŠ Ø§ØªØ±Ø¨Ø· Ø¨ÙŠÙ‡Ø§.
* Ø§Ù„ `status` â†’ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©.

Ø¥Ù†Øª Ù…Ù† Ù†Ø§Ø­ÙŠØªÙƒ ØªØ³ØªÙ‚Ø¨Ù„ Ø¯Ù‡ ÙÙŠ **Endpoint** Ø¹Ù†Ø¯Ùƒ (Ù…Ø«Ù„Ø§Ù‹ `/api/payment/webhook`).

---

## ğŸŸ¢ Ø«Ø§Ù†ÙŠØ§Ù‹: Ø¥Ø²Ø§ÙŠ ØªØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø±ÙŠÙƒÙˆØ³Øª ÙØ¹Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù€ Gateway Ù…Ø´ FakeØŸ

Ø£ÙŠ Payment Gateway Ù…Ø­ØªØ±Ù… Ø¨ÙŠØ¯ÙŠÙƒ ÙˆØ³ÙŠÙ„Ø© ØªØ­Ù‚Ù‚ØŒ ØºØ§Ù„Ø¨Ù‹Ø§ ÙˆØ§Ø­Ø¯Ø© Ù…Ù† Ø¯ÙˆÙ„:

### 1. **Signature Header** (Ø§Ù„Ø£ÙƒØ«Ø± Ø´ÙŠÙˆØ¹Ù‹Ø§)

* Ø§Ù„Ø¬ÙŠØªÙˆØ§ÙŠ Ø¨ÙŠØ¶ÙŠÙ Header ÙÙŠ Ø§Ù„Ø±ÙŠÙƒÙˆØ³Øª Ø²ÙŠ:
  `X-Signature` Ø£Ùˆ `Stripe-Signature` Ø£Ùˆ `Paymob-Signature`.
* Ù‡Ùˆ Ø¨ÙŠØ¹Ù…Ù„ HMAC (ØªØ´ÙÙŠØ±) Ù„Ù„Ù€ Body Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Secret Key.
* Ø¥Ù†Øª Ù…Ù† Ù†Ø§Ø­ÙŠØªÙƒ ØªØ¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù€ HMAC ÙˆØªÙ‚Ø§Ø±Ù† Ø¨Ø§Ù„Ù„ÙŠ Ø¬Ø§Ù„Ùƒ.

```csharp
using System.Security.Cryptography;
using System.Text;

bool VerifySignature(string payload, string signature, string secret)
{
    var keyBytes = Encoding.UTF8.GetBytes(secret);
    using var hmac = new HMACSHA256(keyBytes);
    var hash = hmac.ComputeHash(Encoding.UTF8.GetBytes(payload));
    var computed = BitConverter.ToString(hash).Replace("-", "").ToLower();
    return computed == signature.ToLower();
}
```

### 2. **IP Whitelisting**

* Ø¨Ø¹Ø¶ Gateways Ø¨ÙŠÙ‚ÙˆÙ„Ùƒ: "Ø¥Ø­Ù†Ø§ Ø¨Ù†Ø¨Ø¹Øª Webhooks Ø¨Ø³ Ù…Ù† IP ranges Ù…Ø¹ÙŠÙ†Ø©".
* ÙØªØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø±ÙŠÙƒÙˆØ³Øª Ø¬Ø§ÙŠ Ù…Ù† IP Ù…ØµØ±Ø­ Ø¨ÙŠÙ‡.
  (Ù…Ø´ ÙƒÙØ§ÙŠØ© Ù„ÙˆØ­Ø¯Ù‡Ø§ØŒ Ø¨Ø³ Ø¨ÙŠØ²ÙˆØ¯ Ø£Ù…Ø§Ù†).

### 3. **Secret Token**

* Ø£Ø­ÙŠØ§Ù†Ù‹Ø§ ÙŠØ·Ù„Ø¨ÙˆØ§ Ù…Ù†Ùƒ ØªØ­Ø· "Secret Token" ÙÙŠ URL Ø£Ùˆ Header.
* Ù…Ø«Ù„Ø§Ù‹:
  `https://mydomain.com/api/payment/webhook?token=XYZ123`
* ÙØ§Ù„Ù€ Gateway ÙŠØ¨Ø¹ØªÙ‡ ÙƒÙ„ Ù…Ø±Ø© ÙˆØ¥Ù†Øª ØªØªØ­Ù‚Ù‚ Ù…Ù†Ù‡.

---

## ğŸŸ¢ Ø«Ø§Ù„Ø«Ø§Ù‹: Ø¥Ø²Ø§ÙŠ ØªØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù€ Webhook Ø¨Ø¹Ø¯ Ù…Ø§ ØªØªØ£ÙƒØ¯ØŸ

Ø§ÙˆÙ„ Ø­Ø§Ø¬Ø© Parse JSON.
ØªØ§Ù†ÙŠ Ø­Ø§Ø¬Ø© Verify signature (Ø£Ùˆ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù„ÙŠ Ø¨ÙŠÙˆÙØ±Ù‡Ø§ Ø§Ù„Ù€ Gateway).
3. Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ `event` Ø£Ùˆ `status`:

   * Ù„Ùˆ `payment_succeeded` â†’ ØªØ­Ø¯Ø« Order ÙÙŠ DB Ø¥Ù„Ù‰ "Paid".
   * Ù„Ùˆ `payment_failed` â†’ ØªØ­Ø¯Ø« Order Ø¥Ù„Ù‰ "Failed".
   * Ù„Ùˆ `refund` â†’ ØªØ­Ø¯Ø« Order Ø¥Ù„Ù‰ "Refunded".
4. ØªØ±Ø¬Ø¹ Response Ø¨Ù€ **200 OK** Ù„Ù„Ø¬ÙŠØªÙˆØ§ÙŠ â†’ ÙƒØ¯Ù‡ Ù‡Ùˆ Ø¹Ø§Ø±Ù Ø¥Ù†Ùƒ Ø§Ø³ØªÙ‚Ø¨Ù„Øª.

---

## ğŸŸ¢ Ø§Ù„Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ Ø§Ù„ØµØ­

* Ø§Ù„Ù€ **Webhook Ù‡Ùˆ Ø§Ù„Ù€ Source of Truth**.
* Ø§Ù„Ù€ Redirect URL (success/fail page) Ù…Ø¬Ø±Ø¯ **User Experience**.
* ÙŠØ¹Ù†ÙŠ Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§ÙˆØµÙ„Ø´ Success pageØŒ Ø¹Ù†Ø¯Ùƒ Ø¨Ø±Ø¶Ù‡ Webhook ÙŠØ«Ø¨Øª Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¯ÙØ¹.

---

## ğŸŸ¢ Ø¥Ø¬Ø§Ø¨Ø© ÙÙŠ Ø§Ù„Ø§Ù†ØªØ±ÙÙŠÙˆ:

Ù„Ùˆ Ø³Ø£Ù„Ùƒ: "Ø¥Ø²Ø§ÙŠ ØªØ¶Ù…Ù† Ø¥Ù† Ø§Ù„Ù€ Webhook Ø§Ù„Ù„ÙŠ Ø¬Ø§Ù„Ùƒ Ø­Ù‚ÙŠÙ‚ÙŠØŸ"
ØªÙ‚ÙˆÙ„:

> "Ø£Ù†Ø§ Ø¨Ø¹Ù…Ù„ Verify Ù„Ù„Ù€ Webhook Ø¥Ù…Ø§ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Signature (HMAC using secret key) Ø£Ùˆ Token Ø£Ùˆ IP Whitelist Ø­Ø³Ø¨ Ø§Ù„Ù„ÙŠ Ø¨ÙŠÙˆÙØ±Ù‡ Ø§Ù„Ù€ Gateway. ÙƒØ¯Ù‡ Ø£ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø±ÙŠÙƒÙˆØ³Øª Ø¬Ø§ÙŠ Ù…Ù† Ù…ØµØ¯Ø± Ø±Ø³Ù…ÙŠ Ù…Ø´ Ø­Ø¯ Ø¨ÙŠØ¹Ù…Ù„ Fake POST."

---

ØªÙ…Ø§Ù…ØŒ Ø±ÙƒØ² Ù…Ø¹Ø§ÙŠØ§ ğŸ‘Œ

Ø§Ù„Ù€ **Webhook** Ù‡Ùˆ ÙÙŠ Ø§Ù„Ø¢Ø®Ø± Ù…Ø¬Ø±Ø¯ **HTTP Request (Ø¹Ø§Ø¯Ø© POST)** Ø¨ÙŠØ¬ÙŠÙ„Ùƒ Ù…Ù† Ø§Ù„Ù€ Payment Gateway Ø¹Ù„Ù‰ Endpoint Ø¥Ù†Øª Ø¹Ø§Ù…Ù„Ù‡ Ø¹Ù†Ø¯Ùƒ ÙÙŠ Ø§Ù„Ù€ API.

### 1- Ø´ÙƒÙ„ Ø§Ù„Ù€ Request Ø¨ÙŠÙƒÙˆÙ† Ø¥Ø²Ø§ÙŠØŸ

* Ø¨ÙŠØ¬ÙŠÙ„Ùƒ **POST Request** Ø¹Ù„Ù‰ Ø§Ù„Ù€ URL Ø§Ù„Ù„ÙŠ Ø¥Ù†Øª Ù…Ø³Ø¬Ù„Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ù€ Gateway (Ù…Ø«Ù„Ø§Ù‹: `https://myapp.com/api/webhooks/payment`).
* Ø§Ù„Ù€ Body Ø¨ÙŠÙƒÙˆÙ† ØºØ§Ù„Ø¨Ù‹Ø§ **JSON** ÙÙŠÙ‡ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¯Ø« (Event) Ø§Ù„Ù„ÙŠ Ø­ØµÙ„ØŒ Ù…Ø«Ø§Ù„:

```json
{
  "id": "evt_12345",
  "type": "payment_success",
  "data": {
    "transactionId": "tx_98765",
    "amount": 5000,
    "currency": "USD",
    "status": "succeeded",
    "customerEmail": "user@example.com"
  }
}
```

Ù…Ù…ÙƒÙ† Ø§Ù„Ù†ÙˆØ¹ ÙŠÙƒÙˆÙ† Ù…Ø®ØªÙ„Ù Ø­Ø³Ø¨ Ø§Ù„Ù€ Gateway: Ø²ÙŠ `payment_failed`, `refund_issued`, Ø¥Ù„Ø®.

---

### 2- Ø¥Ø²Ø§ÙŠ Ø£ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø±ÙŠÙƒÙˆÙŠØ³Øª Ø¯Ù‡ Ø¬Ø§ÙŠ Ù…Ù† Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„ØµØ­ Ù…Ø´ Ø­Ø¯ Ø¨ÙŠÙ‡ÙƒØ±Ù†ÙŠØŸ

ÙÙŠÙ‡ Ø·Ø±Ù‚ Ù…Ø®ØªÙ„ÙØ© ÙˆØ§Ù„Ù€ Gateways Ø¹Ø§Ø¯Ø© Ø¨ØªÙˆÙØ± ÙˆØ§Ø­Ø¯Ø© Ø£Ùˆ Ø£ÙƒØªØ±:

#### âœ… Ø£- **Secret Key / Signature Verification** (Ø§Ù„Ø£Ø´Ù‡Ø±):

* Ù…Ø¹ ÙƒÙ„ WebhookØŒ Ø§Ù„Ù€ Gateway Ø¨ÙŠØ¨Ø¹Øª Header ÙÙŠÙ‡ ØªÙˆÙ‚ÙŠØ¹ (Signature).
* Ø¥Ù†Øª Ø¨ØªØ§Ø®Ø¯ Ø§Ù„Ù€ Body Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ + Secret Key (Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ùƒ) ÙˆØªØ¹Ù…Ù„ Hash Ø¨Ù†ÙØ³ Ø§Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© (Ø¹Ø§Ø¯Ø© HMAC-SHA256).
* Ù„Ùˆ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù„ÙŠ Ø¥Ù†Øª Ø·Ù„Ø¹ØªÙ‡ = Ø§Ù„Ù„ÙŠ ÙÙŠ Ø§Ù„Ù€ Header â†’ ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø±ÙŠÙƒÙˆÙŠØ³Øª Ø£ØµÙ„ÙŠ.
* Ù…Ø«Ø§Ù„ Header Ù…Ù† Stripe:

  ```
  Stripe-Signature: t=1234567890,v1=abcdef123456
  ```

#### âœ… Ø¨- **IP Whitelisting**:

* Ø¨Ø¹Ø¶ Gateways Ø¨ØªÙ‚ÙˆÙ„Ùƒ: "Ø§Ù„Ù€ Webhook Ù‡ÙŠØ¬ÙŠÙ„Ùƒ Ù…Ù† IP ranges Ù…Ø¹ÙŠÙ†Ø©"ØŒ ÙØ¥Ù†Øª ØªØªØ­Ù‚Ù‚ Ø¥Ù† Ø§Ù„Ù€ Request Ø¬Ø§ÙŠ Ù…Ù† IP Ø¶Ù…Ù† Ø§Ù„Ù„ÙŠ Ù‚Ø§ÙŠÙ„ÙŠÙ† Ø¹Ù„ÙŠÙ‡.

#### âœ… Ø¬- **Basic Authentication / API Key in Header**:

* Ø£Ø­ÙŠØ§Ù†Ù‹Ø§ Ø¨ÙŠØ¨Ø¹ØªÙˆØ§ Ù…Ø¹ ÙƒÙ„ Webhook API Key Ø£Ùˆ Token ÙÙŠ Ø§Ù„Ù€ Header ÙˆØ¥Ù†Øª ØªØªØ­Ù‚Ù‚ Ø¥Ù†Ù‡ ØµØ­ÙŠØ­.

---

### 3- Ø¥Ø²Ø§ÙŠ ØªØªØ¹Ø§Ù…Ù„ Ø¹Ù…Ù„ÙŠÙ‹Ø§ØŸ

* ØªØ¹Ù…Ù„ Controller Ø£Ùˆ Endpoint Ù…Ø®ØµØµ Ø²ÙŠ:

```csharp
[ApiController]
[Route("api/webhooks")]
public class WebhookController : ControllerBase
{
    [HttpPost("payment")]
    public IActionResult HandlePaymentWebhook([FromBody] JsonElement payload)
    {
        // Step 1: Verify Signature (depends on gateway)
        var signature = Request.Headers["X-Signature"];
        bool isValid = VerifySignature(payload, signature);

        if (!isValid)
            return Unauthorized();

        // Step 2: Process Event
        var eventType = payload.GetProperty("type").GetString();
        if (eventType == "payment_success")
        {
            var transactionId = payload.GetProperty("data").GetProperty("transactionId").GetString();
            // Update Order status in DB
        }

        // Step 3: Return 200 OK Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ Gateway ÙŠØ¹Ø±Ù Ø¥Ù†Ùƒ Ø§Ø³ØªÙ‚Ø¨Ù„Øª Ø§Ù„Ø­Ø¯Ø«
        return Ok();
    }
}
```

---

### 4- Ù„ÙŠÙ‡ Webhook Ù…Ù‡Ù…ØŸ

Ù„Ø£Ù†Ù‡ Ø¨ÙŠØ­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù„ÙŠ Ø¥Ù†Øª Ø³Ø£Ù„Øª Ø¹Ù†Ù‡Ø§ Ù‚Ø¨Ù„ ÙƒØ¯Ù‡:
Ù„Ùˆ Ø§Ù„Ù†Øª Ù‚Ø·Ø¹ ÙˆØ§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§ ÙˆØµÙ„Ø´ Ù„Ù€ Order Confirmation Page â†’ Ø§Ù„Ù€ Webhook Ù‡ÙŠÙˆØµÙ„Ùƒ Ùˆ ØªØ¹Ø±Ù Ø¥Ù† Ø§Ù„Ø¯ÙØ¹ ØªÙ… ÙˆØªØ­Ø¯Ø« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø´Ø§ÙØ´.

---

## 1ï¸âƒ£ ÙŠØ¹Ù†ÙŠ Ø¥ÙŠÙ‡ Callback / WebhookØŸ

* Ø§Ù„ **Callback** = Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¨ÙŠØ±Ø¬Ø¹Ù„Ùƒ ÙÙŠÙ‡Ø§ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨ØªØ§Ø¹ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø© (Ù†Ø¬Ø­ Ø§Ù„Ø¯ÙØ¹ / ÙØ´Ù„ / Ù…Ù„ØºÙŠ).
* Ø§Ù„ **Webhook** = Ø·Ø±ÙŠÙ‚Ø© (URL) Ø§Ù†Øª Ø¨ØªØ¬Ù‡Ø²Ù‡Ø§ ÙÙŠ Ø³ÙŠØ³ØªÙ…Ùƒ â†’ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ Ø¨ØªØ¨Ø¹Øª Ø¹Ù„ÙŠÙ‡Ø§ **Request (POST)** ÙÙŠÙ‡ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ù…Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ®Ù„Øµ Ø§Ù„Ø¯ÙØ¹.

Ø¨Ù…Ø¹Ù†Ù‰: Ø¨Ø¯Ù„ Ù…Ø§ ØªÙØ¶Ù„ ØªØ³Ø£Ù„ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© ÙƒÙ„ Ø´ÙˆÙŠØ© â€œÙ‡Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¯ÙØ¹ ÙˆÙ„Ø§ Ù„Ø³Ù‡ØŸâ€ â†’ Ù‡Ù… Ø¨Ù†ÙØ³Ù‡Ù… ÙŠØ¨Ø¹ØªÙˆÙ„Ùƒ Ø¥Ø´Ø¹Ø§Ø± (Notification) Ø£ÙˆÙ„ Ù…Ø§ ÙŠØ­ØµÙ„ ØªØºÙŠÙŠØ± ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹.

---

## 2ï¸âƒ£ Ù…Ø«Ø§Ù„ ÙˆØ§Ù‚Ø¹ÙŠ

* Ù…Ø­Ù…ÙˆØ¯ ÙŠØ·Ù„Ø¨ ÙƒØªØ§Ø¨ Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ.
* Ø§Ù†Øª ØªØ¹Ù…Ù„ **Invoice** ÙÙŠ Paymob Ø£Ùˆ PayTabs.
* Ù…Ø­Ù…ÙˆØ¯ ÙŠØ¯ÙØ¹ Ø¨ÙƒØ§Ø±Øª ÙÙŠØ²Ø§.
* Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© ØªØ¹Ù…Ù„ Ø§ØªÙ†ÙŠÙ†:

  1. ØªÙˆØ±ÙŠ Ù…Ø­Ù…ÙˆØ¯ Ø±Ø³Ø§Ù„Ø© â€œØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­ âœ…â€.
  2. ØªØ¨Ø¹ØªÙ„Ùƒ Ø¹Ù„Ù‰ **Webhook URL** Ø§Ù„Ù„ÙŠ Ø§Ù†Øª Ù…Ø¹Ø±ÙÙ‡ Ø¹Ù†Ø¯Ù‡Ù… (Ø²ÙŠ: `https://yourdomain.com/api/payment/callback`) â†’ JSON ÙÙŠÙ‡:

     * Ø§Ù„ `transaction_id`
     * Ø§Ù„ `order_id`
     * Ø§Ù„ `status` (paid, failed, pending)
     * Ø§Ù„ `amount`

Ø§Ù†Øª ØªØ§Ø®Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¯ÙŠ ÙˆØªØ­Ø¯Ø« Ø§Ù„Ù€DB Ø¹Ù†Ø¯Ùƒ:

* Ù„Ùˆ **paid** â†’ ØªØºÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ù„Ù€ "Ù…Ø¯ÙÙˆØ¹".
* Ù„Ùˆ **failed** â†’ ØªØ¹Ù…Ù„Ù‡ cancel Ø£Ùˆ retry.

---

## 3ï¸âƒ£ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Callback Ùˆ Redirect

* Ø§Ù„ **Redirect URL**: Ø¨Ø¹Ø¯ Ù…Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ¯ÙØ¹ØŒ Ø¨ÙŠØªØ­ÙˆÙ„ Ù„ØµÙØ­Ø© Ø¹Ù†Ø¯Ùƒ (Ù…Ø«Ù„Ø§Ù‹ `/payment/success`). Ø¯Ù‡ Ø¨Ø³ Ø¹Ø´Ø§Ù† ÙŠÙˆØ±ÙŠÙ‡ Ø±Ø³Ø§Ù„Ø©.
* Ø§Ù„ **Webhook/Callback**: Ø¯Ù‡ Ø§Ù„Ù„ÙŠ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø¹ÙÙ…Ø¯Ø© â†’ Ù„Ø£Ù†Ù‡ Ø¨ÙŠØ¨Ø¹ØªÙ„Ùƒ Ù…Ù† Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ù†ÙØ³Ù‡Ø§ Ø¥Ø´Ø¹Ø§Ø± Ø±Ø³Ù…ÙŠ Ø¥Ù† Ø§Ù„ÙÙ„ÙˆØ³ Ø§ØªØ¯ÙØ¹Øª. (Ù…Ù…ÙƒÙ† Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠÙ‚ÙÙ„ Ø§Ù„ØªØ§Ø¨ Ø£Ùˆ Ø§Ù„Ù†Øª ÙŠÙ‚Ø·Ø¹ØŒ Ù„ÙƒÙ† Ø§Ù„Ù€Webhook Ù‡ÙŠØ¬ÙŠÙ„Ùƒ Ø¨Ø±Ø¶Ù‡).

---

## 4ï¸âƒ£ Ø§

 **Ø¥ÙŠÙ‡ Ù‡Ùˆ Ø§Ù„Ù€Webhook ÙˆÙ„ÙŠÙ‡ Ù…Ù‡Ù… ÙÙŠ Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØŸ**
   â€“ Ù‡Ùˆ URL Ø¨ÙŠØ¨Ø¹Øª Ø¹Ù„ÙŠÙ‡ Ù…Ø²ÙˆÙ‘Ø¯ Ø§Ù„Ø¯ÙØ¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ø¹Ø¯ Ù…Ø§ ØªØ®Ù„ØµØŒ Ø¹Ø´Ø§Ù† Ø£Ù‚Ø¯Ø± Ø£Ø¹Ù…Ù„ update ÙÙŠ Ø§Ù„Ø³ÙŠØ³ØªÙ… Ø¨ØªØ§Ø¹ÙŠ Ø¨Ø´ÙƒÙ„ Ø¢Ù„ÙŠ. ÙˆÙ‡Ùˆ Ù…Ù‡Ù… Ù„Ø£Ù†Ù‡ ÙŠØ¶Ù…Ù† Ø¥Ù† Ø§Ù„Ø³ÙŠØ³ØªÙ… ÙŠØ³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹ Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø§ Ø±Ø¬Ø¹Ø´ Ù„Ù„Ù€redirect page.

 **Ø¥Ø²Ø§ÙŠ ØªØ£Ù…Ù‘Ù† Ø§Ù„Ù€WebhookØŸ**
   â€“ Ø£ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ (signature Ø£Ùˆ HMAC) Ø§Ù„Ù„ÙŠ Ø¨ØªØ¨Ø¹Øª Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙƒÙ„ Ø¨ÙˆØ§Ø¨Ø© Ø¨ØªØ¯ÙŠÙƒ secret key ØªØ³ØªØ®Ø¯Ù…Ù‡ Ù„Ù„ØªØ­Ù‚Ù‚ Ø¥Ù† Ø§Ù„Ø±ÙŠÙƒÙˆØ³Øª Ø¬Ø§ÙŠ ÙØ¹Ù„Ù‹Ø§ Ù…Ù†Ù‡Ù… Ù…Ø´ Ù…Ù† Ù‡Ø§ÙƒØ±.

 **Ø¥ÙŠÙ‡ Ø§Ù„Ù„ÙŠ Ù…Ù…ÙƒÙ† ÙŠØ­ØµÙ„ Ù„Ùˆ Ù…Ø§ Ø§Ø³ØªØ®Ø¯Ù…ØªØ´ WebhookØŸ**
   â€“ Ù…Ø´ Ù‡ØªØ¹Ø±Ù Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ø¨Ø¯Ù‚Ø©. Ù…Ù…ÙƒÙ† ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¯ÙØ¹ Ù„ÙƒÙ† Ù…Ø§ Ø±Ø¬Ø¹Ø´ Ù„Ù„ØµÙØ­Ø© â†’ ÙØªÙØªÙƒØ± Ø¥Ù†Ù‡ Ù…Ø§ Ø¯ÙØ¹Ø´.

---


Ù…Ø«Ø§Ù„ Ø¹Ù…Ù„ÙŠ ÙÙŠ **ASP.NET Core Web API** Ù„Ø¹Ù…Ù„ Webhook Endpoint Ø®Ø§Øµ Ø¨Ø§Ù„Ø¯ÙØ¹:

---

##  Ø§Ù„Ø®Ø·ÙˆØ§Øª

1. Ù‡ØªØ¬Ù‡Ø² **Controller** ÙÙŠÙ‡ Action ØªØ³ØªÙ‚Ø¨Ù„ POST Ù…Ù† Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹.
2. Ù‡ØªÙ‚Ø±Ø£ **JSON** Ø§Ù„Ù„ÙŠ Ø¬Ø§ÙŠ Ù…Ù† Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©.
3. Ù‡ØªØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù€ **Signature** (Ù„Ùˆ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ø¨ØªÙˆÙØ±Ù‡) Ø¹Ø´Ø§Ù† ØªØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø±ÙŠÙƒÙˆØ³Øª ØµØ­ÙŠØ­.
4. ØªØ­Ø¯Ø« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ù€Database.

---

##  Ø§Ù„ÙƒÙˆØ¯

```csharp
using Microsoft.AspNetCore.Mvc;

namespace PaymentIntegrationDemo.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class PaymentWebhookController : ControllerBase
    {
        [HttpPost("callback")]
        public IActionResult PaymentCallback([FromBody] PaymentWebhookRequest request)
        {
            // Example: Log or process the payment data
            if (request.Status == "paid")
            {
                // TODO: Update order in database
                Console.WriteLine($"Order {request.OrderId} has been paid successfully.");
            }
            else if (request.Status == "failed")
            {
                // TODO: Handle failed payment
                Console.WriteLine($"Order {request.OrderId} payment failed.");
            }

            // Return 200 OK to acknowledge receipt
            return Ok(new { message = "Webhook received successfully" });
        }
    }

    // This is a model to map the JSON body from the payment gateway
    public class PaymentWebhookRequest
    {
        public string TransactionId { get; set; }
        public string OrderId { get; set; }
        public string Status { get; set; }
        public decimal Amount { get; set; }
    }
}
```

---

## Ù…Ø«Ø§Ù„ Ø¹Ù„ÙŠ Ø§Ù„ JSON Ù…Ù…ÙƒÙ† ÙŠÙˆØµÙ„Ù†Ø§ Ù…Ù† Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©

```json
{
  "transactionId": "TX123456",
  "orderId": "ORD789",
  "status": "paid",
  "amount": 500.00
}
```

---

##  Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø©

* Ù„Ø§Ø²Ù… ØªØ¹Ø±Ù Ø§Ù„Ù€ **Webhook URL** Ø¨ØªØ§Ø¹Ùƒ Ù„Ù„Ø¨ÙˆØ§Ø¨Ø© (Ù…Ø«Ù„Ø§Ù‹: `https://yourdomain.com/api/paymentwebhook/callback`).
* ÙƒÙ„ Ø¨ÙˆØ§Ø¨Ø© Ø¨ØªØ®ØªÙ„Ù ÙÙŠ Ø§Ù„Ù€ **JSON Structure** â†’ ÙÙ„Ø§Ø²Ù… ØªØ·Ø§Ø¨Ù‚Ù‡ Ù…Ø¹ Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ø¨ØªØ§Ø¹ØªÙ‡Ù….
* ØºØ§Ù„Ø¨Ù‹Ø§ Ø¨ÙŠØ¨Ø¹ØªÙˆØ§ **Signature Header** Ø²ÙŠ:

  ```
  X-Signature: HMACSHA256(payload, secret)
  ```

  â†’ Ø³Ø§Ø¹ØªÙ‡Ø§ Ø§Ù†Øª ØªØªØ­Ù‚Ù‚ Ù…Ù†Ù‡ Ù‚Ø¨Ù„ Ù…Ø§ ØªØ­Ø¯Ø« Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø³ÙŠØ³ØªÙ….

---


Ø¥Ø²Ø§ÙŠ ØªØ¶ÙŠÙ Ø§Ù„ Signature Verification ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø­ÙŠØ« ØªØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø±ÙŠÙƒÙˆØ³Øª Ø¬Ø§ÙŠ ÙØ¹Ù„Ù‹Ø§ Ù…Ù† Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ Ù…Ø´ Ù…Ù† Ø£ÙŠ Ø­Ø¯ ØªØ§Ù†ÙŠØŸ ÙˆØ¯ÙŠ Ø§Ù„Ù†Ù‚Ø·Ø© Ø§Ù„Ø£Ù‡Ù… ÙÙŠ Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù€ **Webhook Security**. Ù„Ø£Ù† Ø£ÙŠ Ø­Ø¯ Ù…Ù…ÙƒÙ† ÙŠØ¹Ø±Ù Ø§Ù„Ù€ endpoint Ø¨ØªØ§Ø¹Ùƒ ÙˆÙŠØ­Ø§ÙˆÙ„ ÙŠØ¨Ø¹ØªÙ‡ Ø±ÙŠÙƒÙˆØ³Øª Ù…Ø²ÙŠÙ ÙŠØºÙŠÙ‘Ø± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨.

---

## Ø§Ù„ÙÙƒØ±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©

1. Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ Ø¨ØªØ¨Ø¹ØªÙ„Ùƒ **Body** (Ø§Ù„Ù€ JSON).
2. Ù…Ø¹Ø§Ù‡Ø§ ØªØ¨Ø¹ØªÙ„Ùƒ **Header** ÙÙŠÙ‡ ØªÙˆÙ‚ÙŠØ¹ (Signature).
3. Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¯Ù‡ Ù…Ø¹Ù…ÙˆÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø²ÙŠ **HMAC-SHA256** Ø¨Ø§Ù„Ù€ **Secret Key** Ø§Ù„Ù„ÙŠ Ø£Ù†Øª ÙˆØ§Ø®Ø¯Ù‡ Ù…Ù†Ù‡Ù….
4. Ø§Ù†Øª ØªØ¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¨Ù†ÙØ³Ùƒ â†’ ÙˆØªÙ‚Ø§Ø±Ù† Ù…Ø¹ Ø§Ù„Ù„ÙŠ Ø¬Ø§Ù„Ùƒ ÙÙŠ Ø§Ù„Ù€Header.

   * Ù„Ùˆ Ù…ØªØ·Ø§Ø¨Ù‚ âœ… â† ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø±ÙŠÙƒÙˆØ³Øª ØµØ­ÙŠØ­.
   * Ù„Ùˆ Ù…Ø®ØªÙ„Ù âŒ â† ØªØ±ÙØ¶ Ø§Ù„Ø±ÙŠÙƒÙˆØ³Øª.

---

## Ù…Ø«Ø§Ù„ Ø¹Ù…Ù„ÙŠ ÙÙŠ ASP.NET Core

```csharp
using Microsoft.AspNetCore.Mvc;
using System.Security.Cryptography;
using System.Text;

namespace PaymentIntegrationDemo.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class PaymentWebhookController : ControllerBase
    {
        private const string SecretKey = "your-secret-key-from-gateway";

        [HttpPost("callback")]
        public async Task<IActionResult> PaymentCallback()
        {
            // Read raw body
            using var reader = new StreamReader(Request.Body);
            var body = await reader.ReadToEndAsync();

            // Get signature from headers (example: X-Signature)
            var signatureHeader = Request.Headers["X-Signature"].FirstOrDefault();

            if (!VerifySignature(body, signatureHeader))
            {
                return Unauthorized(new { message = "Invalid signature" });
            }

            // Deserialize JSON body
            var request = System.Text.Json.JsonSerializer.Deserialize<PaymentWebhookRequest>(body);

            if (request.Status == "paid")
            {
                Console.WriteLine($"âœ… Order {request.OrderId} paid successfully!");
                // TODO: Update DB (mark order as paid)
            }
            else
            {
                Console.WriteLine($"âŒ Payment failed for Order {request.OrderId}");
                // TODO: Handle failed payment
            }

            return Ok(new { message = "Webhook received successfully" });
        }

        private bool VerifySignature(string body, string? signatureHeader)
        {
            if (string.IsNullOrEmpty(signatureHeader))
                return false;

            using var hmac = new HMACSHA256(Encoding.UTF8.GetBytes(SecretKey));
            var hash = hmac.ComputeHash(Encoding.UTF8.GetBytes(body));
            var computedSignature = Convert.ToHexString(hash).ToLower();

            return computedSignature == signatureHeader.ToLower();
        }
    }

    public class PaymentWebhookRequest
    {
        public string TransactionId { get; set; }
        public string OrderId { get; set; }
        public string Status { get; set; }
        public decimal Amount { get; set; }
    }
}
```

---

##  Ø´Ø±Ø­ Ø³Ø±ÙŠØ¹ Ù„Ù„ÙƒÙˆØ¯

* Ø§Ù„ `SecretKey`: Ø¯Ù‡ Ø§Ù„Ù€ secret Ø§Ù„Ù„ÙŠ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ Ø¨ØªØ¯Ù‡ÙˆÙ„Ùƒ.
* Ø§Ù„ `VerifySignature`: Ø¨ØªØ­Ø³Ø¨ HMAC-SHA256 Ù…Ù† Ø§Ù„Ù€ body ÙˆØªÙ‚Ø§Ø±Ù†Ù‡ Ø¨Ø§Ù„Ù„ÙŠ ÙÙŠ Ø§Ù„Ù€Header.
* Ù„Ùˆ Ø§Ù„Ù€Signature ØµØ­ÙŠØ­ â† ØªÙƒÙ…Ù‘Ù„ ÙˆØªØ¹Ù…Ù„ Update ÙÙŠ DB.
* Ù„Ùˆ ØºÙ„Ø· â† Ø¨ØªØ±Ø¬Ø¹ `401 Unauthorized`.

---

##  Ø³Ø¤Ø§Ù„ Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ±ÙÙŠÙˆ

**Ø³: Ø¥Ø²Ø§ÙŠ ØªØ¶Ù…Ù† Ø£Ù…Ø§Ù† Ø§Ù„Ù€WebhookØŸ**
Ø¬: Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ (Signature Verification) Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… HMAC ÙˆØ§Ù„Ù€ Secret KeyØŒ ÙˆÙƒÙ…Ø§Ù† Ø¨ØªØ³Ù…Ø­ ÙÙ‚Ø· Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ (Ù…Ù…ÙƒÙ† Ø£ÙÙ„ØªØ± Ø¨Ø§Ù„Ù€ IPs (Ø§Ù„Ø§ÙŠØ¨ÙŠÙ‡Ø§Øª ÙŠØ¹Ù†ÙŠ) Ù„Ùˆ Ø§Ù„Ø´Ø±ÙƒØ© Ø¨ØªØ¯ÙŠ Ø±ÙŠÙ†Ø¬ Ù…Ø¹ÙŠÙ†).

---

* Ø£ÙŠ Request Ø¨ÙŠÙˆØµÙ„Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø¬Ø§ÙŠ Ù…Ù† Ø¹Ù†ÙˆØ§Ù† Ø¥Ù†ØªØ±Ù†Øª (IP Address).
* Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ Ø¹Ù†Ø¯Ù‡Ø§ **Ø³ÙŠØ±ÙØ±Ø§Øª Ù…Ø­Ø¯Ø¯Ø©** Ù‡ÙŠ Ø§Ù„Ù„ÙŠ Ù‡ØªØ¨Ø¹ØªÙ„Ùƒ Ø§Ù„Ù€ Webhook.
* Ø§Ù„Ø´Ø±ÙƒØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© Ø²ÙŠ **Stripe / PayPal / Paymob** Ø³Ø§Ø¹Ø§Øª Ø¨ØªÙ†Ø´Ø± **Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø§Ù„Ù€ IP ranges** Ø§Ù„Ù„ÙŠ Ø§Ù„Ø±ÙŠÙƒÙˆØ³ØªØ§Øª Ù‡ØªÙŠØ¬ÙŠ Ù…Ù†Ù‡Ø§.

---

## Ø¥Ø²Ø§ÙŠ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù€ IPs ÙÙŠ Ø§Ù„Ø£Ù…Ø§Ù†ØŸ

* Ù„Ù…Ø§ ÙŠÙˆØµÙ„Ùƒ Webhook â† Ù‚Ø¨Ù„ Ù…Ø§ ØªØ¹Ø§Ù„Ø¬Ù‡ â† ØªØ´ÙˆÙ **IP Ø¨ØªØ§Ø¹ Ø§Ù„Ù…Ø±Ø³Ù„**.
* Ù„Ùˆ Ø§Ù„Ù€IP Ù…Ø´ Ù…Ù† Ø¶Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚Ø© Ø§Ù„Ù„ÙŠ Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ø£Ø¹Ù„Ù†ØªÙ‡Ø§ â† Ø¨Ø±ÙØ¶Ù‡ ÙÙˆØ±Ù‹Ø§ .

---

## Ù…Ø«Ø§Ù„ Ø¹Ù…Ù„ÙŠ ÙÙŠ ASP.NET Core

```csharp
using Microsoft.AspNetCore.Mvc;

namespace PaymentIntegrationDemo.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class PaymentWebhookController : ControllerBase
    {
        private static readonly string[] AllowedIps = new[]
        {
            "52.11.22.33",    // Example: Gateway IP
            "34.210.55.120"   // Example: Another Gateway IP
        };

        [HttpPost("callback")]
        public IActionResult PaymentCallback([FromBody] PaymentWebhookRequest request)
        {
            var remoteIp = HttpContext.Connection.RemoteIpAddress?.ToString();

            if (!AllowedIps.Contains(remoteIp))
            {
                return Unauthorized(new { message = "Unauthorized IP address" });
            }

            // TODO: Verify signature + process payment
            return Ok(new { message = "Webhook received successfully" });
        }
    }

    public class PaymentWebhookRequest
    {
        public string TransactionId { get; set; }
        public string OrderId { get; set; }
        public string Status { get; set; }
        public decimal Amount { get; set; }
    }
}
```

---

## Ø³Ø¤Ø§Ù„ Ø¥Ù†ØªØ±ÙÙŠÙˆ Ù…ØªÙˆÙ‚Ø¹

**Ø³: Ù„ÙŠÙ‡ Ù…Ù…ÙƒÙ† ØªØ­ØªØ§Ø¬ ØªØ¹Ù…Ù„ IP Filtering Ù„Ù„Ù€ WebhookØŸ**

* Ø¹Ø´Ø§Ù† ØªØ²ÙˆØ¯ Ø·Ø¨Ù‚Ø© Ø£Ù…Ø§Ù† Ø¥Ø¶Ø§ÙÙŠØ©. Ø­ØªÙ‰ Ù„Ùˆ Ø­Ø¯ Ø¹Ø±Ù Ø§Ù„Ù€ Secret Ø£Ùˆ Ø­Ø§ÙˆÙ„ ÙŠØ¨Ø¹Ø« Request Ù…Ø²ÙŠÙØŒ Ù…Ø´ Ù‡ÙŠÙ‚Ø¯Ø± ÙŠÙˆØµÙ„ Ø¥Ù„Ø§ Ù„Ùˆ Ø¬Ø§ÙŠ Ù…Ù† IP Ù…Ø³Ù…ÙˆØ­ Ø¨ÙŠÙ‡ ØªØ§Ø¨Ø¹ Ù„Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹.

---

 ÙƒØ¯Ù‡ Ø¹Ù†Ø¯Ùƒ Ø®Ø· Ø¯ÙØ§Ø¹ Ù…Ø²Ø¯ÙˆØ¬:

 Ø§Ù„ **Signature Verification (HMAC)**
 ÙˆØ§Ù„ **IP Whitelisting**

Ù„Ùˆ Ø§Ù„Ø§ØªÙ†ÙŠÙ† ØµØ­ â† Ø§Ù„Ø±ÙŠÙƒÙˆØ³Øª Ø³Ù„ÙŠÙ….
Ù„Ùˆ ÙˆØ§Ø­Ø¯ ÙÙŠÙ‡Ù… ÙØ´Ù„ â† ØªØ±ÙØ¶.

---

## Ù…Ø«Ø§Ù„ 1. **Paymob (Ø¨ÙˆØ§Ø¨Ø© Ø¯ÙØ¹ Ù…ØµØ±ÙŠØ© Ø´Ù‡ÙŠØ±Ø©)**

### Ø´ÙƒÙ„ Webhook Ø¨ÙŠØ¬ÙŠ Ù…Ù† Paymob

Ø¨Ø¹Ø¯ Ù…Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ¯ÙØ¹ØŒ Paymob Ø¨ØªØ¨Ø¹ØªÙ„Ùƒ JSON ÙƒØ¯Ù‡:

```json
{
  "id": 123456789,
  "amount_cents": 10000,
  "currency": "EGP",
  "order": {
    "id": 987654321,
    "merchant_order_id": "ORD123"
  },
  "success": true,
  "is_voided": false,
  "is_refunded": false,
  "created_at": "2025-09-09T14:30:00Z",
  "source_data": {
    "pan": "2346",
    "sub_type": "MasterCard",
    "type": "card"
  }
}
```

###  Ø§Ù„Ø£Ù…Ø§Ù† Ø¹Ù†Ø¯ Paymob

* Ø¨ÙŠØ¨Ø¹ØªÙˆØ§ Ù…Ø¹ Ø§Ù„Ø±ÙŠÙƒÙˆØ³Øª **HMAC Signature** ÙÙŠ Header.
* Ø§Ù†Øª Ù„Ø§Ø²Ù… ØªØ¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¨Ù†ÙØ³ Ø§Ù„Ø³Ø±Ù‘ Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ùƒ (Integration Key).
* Ù„Ùˆ Ù…ØªØ·Ø§Ø¨Ù‚ âœ… â†’ ØªÙƒÙ…Ù„.

---

## Ù…Ø«Ø§Ù„ 2. **Stripe (ÙˆØ§Ø­Ø¯Ø© Ù…Ù† Ø£Ø´Ù‡Ø± Ø¨ÙˆØ§Ø¨Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø¹Ø§Ù„Ù…ÙŠÙ‹Ø§)**

### Ø´ÙƒÙ„ Webhook Ø¨ÙŠØ¬ÙŠ Ù…Ù† Stripe

Ø§Ù„ Stripe Ø¨ØªØ¨Ø¹Øª Event ÙƒØ§Ù…Ù„ØŒ Ù…Ø«Ù„Ø§Ù‹ Ø§Ù„Ø¯ÙØ¹ Ù†Ø¬Ø­:

```json
{
  "id": "evt_1OzOdh2eZvKYlo2Cgk0c9hfd",
  "object": "event",
  "api_version": "2025-01-01",
  "created": 1725876340,
  "data": {
    "object": {
      "id": "pi_3OzOdG2eZvKYlo2C1vZjqk8Q",
      "object": "payment_intent",
      "amount": 10000,
      "currency": "usd",
      "status": "succeeded"
    }
  },
  "type": "payment_intent.succeeded"
}
```

### Ø§Ù„Ø£Ù…Ø§Ù† Ø¹Ù†Ø¯ Stripe

* Ø¨ÙŠØ¨Ø¹ØªÙˆØ§ **Stripe-Signature Header**.
* Ø§Ù†Øª Ù„Ø§Ø²Ù… ØªØ³ØªØ®Ø¯Ù… Ù…ÙƒØªØ¨ØªÙ‡Ù… Ø£Ùˆ ÙƒÙˆØ¯ HMAC Ù„Ù„ØªØ­Ù‚Ù‚.
* ÙƒÙ…Ø§Ù† Ø¨ÙŠÙ‚ÙˆÙ„ÙˆØ§ ØªÙ‚Ø¯Ø± ØªØ­Ø¯Ø¯ **IP ranges** Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø³ÙŠØ±ÙØ±Ø§ØªÙ‡Ù… Ù„Ùˆ Ø¹Ø§ÙŠØ² Double Security.

---

## Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Paymob Ùˆ Stripe

| Ø§Ù„Ø¹Ù†ØµØ±              | Paymob                                | Stripe                             |
| ------------------- | ------------------------------------- | ---------------------------------- |
| **Ø§Ù„Ù…ÙƒØ§Ù†**          | Ù…ØµØ± / MENA                            | Ø¹Ø§Ù„Ù…ÙŠ                              |
| **Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©** | EGP                                   | USD + ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Øª                   |
| **Ø§Ù„Ù€Webhook**      | JSON Ø¨Ø³ÙŠØ· Ù…Ø¹ HMAC                     | JSON Ù…Ø¹ Event ÙƒØ§Ù…Ù„ + ØªÙˆÙ‚ÙŠØ¹         |
| **Ø§Ù„Ø£Ù…Ø§Ù†**          | HMAC Signature                        | Signature + IP Filtering           |
| **Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¹Ù…Ù„ÙŠ**    | Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù…ØµØ±ÙŠ (ÙÙŠØ²Ø§/Ù…Ø§Ø³ØªØ± Ù…Ø­Ù„ÙŠØ©) | Ø¹Ø§Ù„Ù…ÙŠ Ù…Ø¹ Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ£Ø¨Ù„ Ø¨Ø§ÙŠ ÙˆØ¬ÙˆØ¬Ù„ Ø¨Ø§ÙŠ |

---

## Ø³Ø¤Ø§Ù„ Ø¥Ù†ØªØ±ÙÙŠÙˆ Ù…ØªÙˆÙ‚Ø¹

**Ø³: Ù„Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¯ÙØ¹ Ø§Ù„ÙÙ„ÙˆØ³ Ø¨Ø³ Ø§Ù„Ù†Øª Ù‚Ø·Ø¹ Ø¹Ù†Ø¯Ù‡ Ù‚Ø¨Ù„ Ù…Ø§ ÙŠØ±Ø¬Ø¹ Ù„Ù„Ù€ Redirect URLØŒ Ø¥Ø²Ø§ÙŠ ØªØ¹Ø±Ù Ø¥Ù† Ø§Ù„ÙÙ„ÙˆØ³ Ø¯Ø®Ù„ØªØŸ**
Ø¬: Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„Ù€ Webhook. Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ù‡ØªØ¨Ø¹ØªÙ„ÙŠ Ø¥Ø´Ø¹Ø§Ø± Ø±Ø³Ù…ÙŠ Ø¥Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© = paid Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø§ Ø±Ø¬Ø¹Ø´ Ù„Ù„ØµÙØ­Ø©.


---

## ğŸ“Œ 1. Ø´ÙƒÙ„ JSON Ù…Ù† Paymob (Webhook Event)

Ù…Ø«Ø§Ù„ Ù…Ø¨Ø³Ø·:

```json
{
  "id": 123456789,
  "amount_cents": 10000,
  "currency": "EGP",
  "order": {
    "id": 987654321,
    "merchant_order_id": "ORD123"
  },
  "success": true,
  "is_voided": false,
  "is_refunded": false,
  "created_at": "2025-09-09T14:30:00Z",
  "source_data": {
    "pan": "2346",
    "sub_type": "MasterCard",
    "type": "card"
  }
}
```

---

## ğŸ“Œ 2. Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ ASP.NET Core

```csharp
using Microsoft.AspNetCore.Mvc;
using System.Security.Cryptography;
using System.Text;
using System.Text.Json;

namespace PaymentIntegrationDemo.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class PaymobWebhookController : ControllerBase
    {
        private const string SecretKey = "YOUR_PAYMOB_HMAC_SECRET";

        [HttpPost("callback")]
        public async Task<IActionResult> Callback()
        {
            // Read raw body (JSON)
            using var reader = new StreamReader(Request.Body);
            var body = await reader.ReadToEndAsync();

            // Get HMAC signature from headers
            var signature = Request.Headers["hmac"].FirstOrDefault();

            if (!VerifyHmac(body, signature))
            {
                return Unauthorized(new { message = "Invalid HMAC signature" });
            }

            // Deserialize JSON
            var request = JsonSerializer.Deserialize<PaymobWebhookRequest>(body);

            if (request.Success)
            {
                Console.WriteLine($"âœ… Order {request.Order.MerchantOrderId} paid successfully!");
                // TODO: Update order status in DB
            }
            else
            {
                Console.WriteLine($"âŒ Payment failed for Order {request.Order.MerchantOrderId}");
                // TODO: Handle failed payment
            }

            return Ok(new { message = "Webhook received" });
        }

        private bool VerifyHmac(string body, string? receivedSignature)
        {
            if (string.IsNullOrEmpty(receivedSignature))
                return false;

            using var hmac = new HMACSHA512(Encoding.UTF8.GetBytes(SecretKey));
            var hash = hmac.ComputeHash(Encoding.UTF8.GetBytes(body));
            var computedSignature = BitConverter.ToString(hash).Replace("-", "").ToLower();

            return computedSignature == receivedSignature.ToLower();
        }
    }

    // Map Paymob Webhook JSON
    public class PaymobWebhookRequest
    {
        public long Id { get; set; }
        public int Amount_Cents { get; set; }
        public string Currency { get; set; }
        public PaymobOrder Order { get; set; }
        public bool Success { get; set; }
        public bool Is_Voided { get; set; }
        public bool Is_Refunded { get; set; }
        public DateTime Created_At { get; set; }
        public SourceData Source_Data { get; set; }
    }

    public class PaymobOrder
    {
        public long Id { get; set; }
        public string MerchantOrderId { get; set; }
    }

    public class SourceData
    {
        public string Pan { get; set; }
        public string Sub_Type { get; set; }
        public string Type { get; set; }
    }
}
```

---

## ğŸ“Œ 3. Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø©

* Ù„Ø§Ø²Ù… ØªØ¬ÙŠØ¨ Ø§Ù„Ù€ **HMAC Secret Key** Ù…Ù† Paymob Dashboard.
* Ø§Ù„ Paymob Ø¨ÙŠØ¨Ø¹Øª Ø§Ù„Ù€ HMAC ÙÙŠ Header Ø§Ø³Ù…Ù‡ `hmac`.
* Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ù€ Algorithm Ø§Ù„Ù„ÙŠ Paymob Ø¨ØªÙ‚ÙˆÙ„ Ø¹Ù„ÙŠÙ‡ (ÙÙŠ Docs Ø¨ØªØ§Ø¹ØªÙ‡Ù… Ø£ØºÙ„Ø¨ Ø§Ù„ÙˆÙ‚Øª HMAC-SHA512).
* Ø¨Ø¹Ø¯ Ù…Ø§ ØªØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ ÙˆØªØ¹Ù…Ù„ Deserialize â†’ Ø­Ø¯Ù‘Ø« Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ù€DB.

---

## Ø³Ø¤Ø§Ù„ Ø¥Ù†ØªØ±ÙÙŠÙˆ Ù…ØªÙˆÙ‚Ø¹

**Ø³: Ø¥Ø²Ø§ÙŠ ØªÙ‚Ø¯Ø± ØªØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ù€ Webhook Ø§Ù„Ù„ÙŠ Ø¬Ø§Ù„Ùƒ Ù…Ù† Paymob Ù…Ø´ FakeØŸ**

* Ø£Ø±Ø¯:

  1. Ø£ØªØ­Ù‚Ù‚ Ù…Ù† HMAC Signature Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ Secret Key.
  2. Ø£ÙÙ„ØªØ± Ø§Ù„Ù€ IPs (Ù„Ùˆ Paymob Ù†Ø´Ø±Øª Ø±ÙŠÙ†Ø¬ IPs).
  3. Ø£Ø³Ø¬Ù„ ÙƒÙ„ Webhook Ù„Ù„Ù€ Auditing Ø¹Ø´Ø§Ù† Ø£Ù‚Ø¯Ø± Ø£Ø±Ø§Ø¬Ø¹ Ø¨Ø¹Ø¯ÙŠÙ†.
