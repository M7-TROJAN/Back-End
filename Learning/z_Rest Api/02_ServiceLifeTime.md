
##  ุงููุงุน ุงูู Lifetime

| ุงูููุน         | ุฏูุฑุฉ ุงูุญูุงุฉ                                              | ูุซุงู ูุจุณุท                                        |
| ------------- | -------------------------------------------------------- | ------------------------------------------------ |
| **Transient** | ูุงุฆู ุฌุฏูุฏ ูู ูู ูุฑุฉ ูุชู ุทูุจู                             | ูู ูุฑุฉ ุชูุงุฏู ุนูู ุงูุณูุฑููุณุ ุจูุนูู `new`           |
| **Scoped**    | ูุงุฆู ูุงุญุฏ ุทูู ุนูุฑ ุงูู HTTP Request                       | ุงููุงุฆู ุจูุชุนูู ุฃูู ูุฑุฉ ูุชูุถู ููุณ ุงููุณุฎุฉ ุทูู ุงูุทูุจ |
| **Singleton** | ูุงุฆู ูุงุญุฏ ุจูุชุนูู ูุฑุฉ ูุงุญุฏุฉ ุนูุฏ ุชุดุบูู ุงูุชุทุจูู ูููุถู ููุฌูุฏ | ุจูุนูุด ุทูู ุนูุฑ ุงูู application                    |

---

## ูุซุงู ุนูู `ApplicationDbContext`

### ููู ุฏุงูููุง ุจูุณุชุฎุฏู `AddScoped<ApplicationDbContext>()`ุ

ูุฃู `DbContext` ูุงุฒู:

* ูููู ูู **ุญุงูุฉ ูุณุชููุฉ ููู Request**.
* ูุฃู **ุชุฒุงูู (Concurrency)** ูู ุงุณุชุฎุฏุงูู ูููู ูุนูู ูุดุงูู ูู ุชู ูุดุงุฑูุชู ุจูู ุทูุจูู ูุฎุชูููู.

### ูู ุงุณุชุฎุฏูุชู ุจู Singleton

* ููุชู ูุดุงุฑูุฉ ููุณ ุงูู `DbContext` ุจูู ูู ุงูุทูุจุงุช ูุฏู ูุดููุฉ ูุจูุฑุฉ!
* ููุญุตู **Thread Safety Issues** ูุฃู ุงูู DbContext ูุด ูุตูู ูุจูู ูุดุชุฑู.

### ููู ุงุณุชุฎุฏูุชู ุจู Transient

* ููุชุนูู Object ุฌุฏูุฏ **ูู ูู ูุฑุฉ ูุชู ูููุง ุญููู**.
* ุฏู ูููู ูุคุฏู ููุฌูุฏ ุฃูุซุฑ ูู `DbContext` ูููุณ ุงูู request ููุญุตู **tracking conflict** ุฃู **ูุดููุฉ ุญูุธ ุจูุงูุงุช ูุด ูุชุฒุงููุฉ**.

>  ุนูุดุงู ูุฏู `Scoped` ูู ุงูุฎูุงุฑ ุงููุซุงูู ูุน `DbContext`:
ูุฏู ูุฃูู
* ุจูุถูู ูุณุฎุฉ ูุงุญุฏุฉ ููู Request.
* ููุญุงูุธ ุนูู ุชุชุจุน ุงูููุงูุงุช `ChangeTracking`.
* ูุจูููุน ุชุฏุงุฎู ุงูุงุณุชุฎุฏุงู.

---

## ๐ ุทูุจ... ุฅูุชู ุฃุณุชุฎุฏู ูู ููุน ุชุงููุ ุจุงูุณููุงุฑูููุงุช:

### ุงู **Transient** ุงูุชู ูุณุชุฎุฏููุ

ููุง ูููู ุงูุณูุฑููุณ **stateless**ุ ูุนูู:

* ูููููุด ุฏุงุชุง ุจุชุชุฎุฒู.
* ููููุด ุญุงูุฉ ูุงุฒู ุชุชุจุนูุง.
* ุฃู ุจูุดุชุบู ูุฃุฏุงุฉ utility.

#### ุฃูุซูุฉ:

* ุงู `EmailSenderService`
* ุงู `ICalculatorService`
* ุงู `ITokenGenerator`

#### ููู Transient ููุงุ

ูุฃู ูููุด ุฃู ูููุฉ ูู ุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ููุณ ุงููุงุฆูุ ูููุงู ูุด ุจูุฎุฒู ุญุงูุฉุ ููู ูุฑุฉ ูุนููู `new` ุฏู ุทุจูุนู ูุขูู.

---

### ุงู **Scoped** ุงูุชู ูุณุชุฎุฏููุ

ููุง ุชููู ุงูุฎุฏูุฉ:

* ูุญุชุงุฌุฉ ุชุญุชูุธ ุจุญุงูุฉ ุฎูุงู **ุทูุจ ูุงุญุฏ ููุท**.
* ุฃู ุจุชุชุนุงูู ูุน ุฏุงุชุง ูุฑุชุจุทุฉ ุจุงูู Request (ุฒู ุงูู User ุฃู ุงูู DB).

#### ุฃูุซูุฉ:

* ุงู `ApplicationDbContext`
* ุงู `IUserSessionService` (ุงููู ุจูุฌูุจ ุจูุงูุงุช ุงูููุฒุฑ ูู ุงูููููุฒ ุฃู ุงูุชููู)
* ุงู `IUnitOfWork`

#### ููู Scoped ููุงุ

ุนูุดุงู ูุถูู consistency ูู ุงูุฏุงุชุง ุงููู ุดุบุงููู ุนูููุง ุฏุงุฎู ููุณ ุงูู request.

---

### ุงู  **Singleton** ุงูุชู ูุณุชุฎุฏููุ

ููุง ุชููู ุงูุฎุฏูุฉ:

* ูููุง ุจูุงูุงุช **ุซุงุจุชุฉ ููุด ุจุชุชุบูุฑ**.
* ุฃู ูููุง ุนูููุงุช ููููุฉ ูุนุงูุฒ ุชุนูุฏ ุงุณุชุฎุฏุงููุง ุทูู ุงูููุช.
* ูููููุงุด ุฃู ุชุนุงูู ูุน ุงูู HTTP ุฃู ุงูู Request ุฃู ุงููุณุชุฎุฏู.

#### ุฃูุซูุฉ:

* ุงู `IConfiguration` (ุงูู appsettings)
* ุงู `ILogger<>`
* ุงู `CachingService` (ูู ุจูุณุชุฎุฏู in-memory static cache)

#### ุชุญุฐูุฑ ููู:

ูู ุฎุฏุช Singleton ูุญููุช ููู Scoped ุฃู Transient ุฏู ูุดููุฉ ููุชุฏุฎู ูู **Captive Dependency Problem**.

---

## ุฃูู ูุงุนุฏุฉ: Lifetime ุงูุฃุทูู ููุญููุด ุงูุฃูุตุฑ!

| ุงูุญูู                   | ูู ูููุนุ |
| ----------------------- | -------- |
| Singleton โ Scoped โ    |          |
| Singleton โ Transient โ |          |
| Scoped โ Transient โ    |          |
| Transient โ Scoped โ    |          |

> ุงู  Singleton ูุจููููุด requestุ ููู ุญููุช ููู Scopedุ ูุชุฌูุจ ูุงุฆู ุจูุจุต ุนูู ุญุงุฌุฉ ูุด ููุฌูุฏุฉ ุฃุตูุงู!

---

## ุชูุฏุฑ ุชุดุจูู ุจูุฏุฉ

* ุงู **Transient** = ุฒู ููุจุงูุฉ ุจูุงุณุชูู ุจุชุชุฑูู ุจุนุฏ ูู ุดุฑุจ.
* ุงู **Scoped** = ุฒู ููุจุงูุฉ ุฒุฌุงุฌ ุจุชุณุชุฎุฏููุง ุทูู ุงูููู ุจุณ ุจุชุบุณููุง ุขุฎุฑู.
* ุงู **Singleton** = ุฒู ููุชุฑ ุงูููุงู ูู ุงูุจูุชุ ุจุชุณุชุฎุฏูู ุฏุงูููุง ููุด ุจุชุบูุฑู ุฅูุง ุจุนุฏ ุดููุฑ.

---

## ูุซุงู ูุงูู ุจููุฏ

```csharp
// Startup.cs ุฃู Program.cs
services.AddTransient<IEmailSender, EmailSender>();
services.AddScoped<IUserService, UserService>();
services.AddSingleton<ICurrencyConverter, CurrencyConverter>();

// Example usage inside a Controller
public class HomeController : Controller
{
    private readonly IUserService _userService;
    private readonly IEmailSender _emailSender;

    public HomeController(IUserService userService, IEmailSender emailSender)
    {
        _userService = userService;
        _emailSender = emailSender;
    }

    public IActionResult Index()
    {
        var user = _userService.GetCurrentUser();
        _emailSender.SendEmail(user.Email, "Hello!");

        return View();
    }
}
```

---

## ุชูุตูุงุช

| ุงูุญุงูุฉ                                               | ุงุณุชุฎุฏู        |
| ---------------------------------------------------- | ------------- |
| ุจุชุชุนุงูู ูุน DB ุฃู session ุฃู request-specific         | **Scoped**    |
| Utility ุฃู Tool ุจุณูุทุฉ ุจุฏูู ุญุงูุฉ                      | **Transient** |
| Config ุฃู Services ุซุงุจุชุฉ ุจุชุญุชุงุฌ ุฃุฏุงุก ุนุงูู ุฃู caching | **Singleton** |

---


## ุชุฎูู ุงูุณููุงุฑูู:

> *ููุฒุฑ ูุชุญ ุตูุญุฉ `Products` โ ุญุตู HTTP Request โ ุงูููุชุฑููุฑ ุญูู ููู `ApplicationDbContext` โ ุฌุงุจ ุฃูู 10 ููุชุฌุงุช โ ุฑุฌุนูู ูู ุงูู Response.*

### ุชุนุงู ูุดูู ุฅูู ุงููู ุจูุญุตู ุจุงูุชุฑุชูุจ ุฏุงุฎูููุง

---

## ุฃููุงู: ุงูู ุงููู ุจูุญุตู ููุง ุงูููุฒุฑ ููุชุญ ุงูุตูุญุฉ (ุฃูู Request)ุ

### 1. ุงููุชุตูุญ ุจุนุช Request ูุซูุงู:

```
GET /Products?page=1
```

### ุจุนุฏ ูุฏุฉ ุงู ASP.NET Core ุนูู ุงูุขุชู:

* ุฃูุดุฃ **HTTP Request Scope ุฌุฏูุฏ** (ูุนูู ุจูุจุฏุฃ ุญูุงุฉ ุฌุฏูุฏุฉ ูููุงุฆูุงุช ุงููู `AddScoped`).
* ุฌูู ุงูู Scope ุฏูุ ุจูุจุฏุฃ ูุญู ุงูู Dependencies ุงููุทููุจุฉ ููููุชุฑููุฑ.
* ุงูููุชุฑููุฑ ููู `ApplicationDbContext`ุ ูู DI container ุงูู ูู ุงููุณุคูู ุนู ุงูุญูู ุนูู:

```csharp
var dbContext = new ApplicationDbContext(...);
```

* ุงููุงุฆู ุฏู ุจูุนูุด ุทูู ูุชุฑุฉ ุงูู Request ุฏู ูุจุณ.

### ููู:

> ุฃู Service ุชุงููุฉ ูู ููุณ ุงูู Scope ูุจุชุทูุจ `ApplicationDbContext` ูุชุณุชูู **ููุณ ุงููุณุฎุฉ** ูุด ูุณุฎุฉ ุฌุฏูุฏุฉ.

---

### 3. ุฏูููู ุงูููุชุฑููุฑ ุงุดุชุบู:

* ุงุณุชุฎุฏู `dbContext.Products.Skip(0).Take(10)` ูุฌุงุจ ุงูุจูุงูุงุช.
* ุฑุฌูุนูู ูู `View` ุฃู `JSON`.

### 4. ุจุนุฏ ูุง ุงู response ุฎูุต ูุฎูุงุต ุงุชุจุนุช ููููุฒุฑ:

* ุงู ASP.NET Core **ุจููููุด ูู ุงููุงุฆูุงุช scoped** ุชููุงุฆููุง.
* ูุนูู ุงูู `ApplicationDbContext` **ุจูุชุนููู Dispose ุชููุงุฆููุง** (ูุฃู `DbContext` ุจู implement `IDisposable`).

---

## ุฏูููุชู ุงูููุฒุฑ ุนูู ุณูุฑูู ูู ุงููููุน ูุชุญุช ูุนูู AJAX Request ุฌุฏูุฏ ูุนูู ุนุงูุฒ ุงูุตูุญุฉ ุงูู ุจุนุฏ ูุฏุฉ:

### GET /Products?page=2

* ุงู Request ุงูุฌุฏูุฏ = Scope ุฌุฏูุฏ = `DbContext` ุฌุฏูุฏ.
* ูู ุญุงุฌุฉ ุจุชุจุฏุฃ ุชุงูู ูู ุงูุตูุฑ.
* ููู ูุฃููุง ุนุงูููู `Scoped`ุ ูู ุฏู ุงููุชููุน ูุงููุทููุจ.

---

## ุฎูุงุตุฉ ููู ุงูู Scoped ููุง:

| ุงูุนูุตุฑ                       | ุงููุนูู                             |
| ---------------------------- | ---------------------------------- |
| ูุฏุฉ ุงูุญูุงุฉ                   | ูู ุจุฏุงูุฉ ุงูู HTTP Request ูููุงูุชู  |
| ุนุฏุฏ ุงููุณุฎ ูู ููุณ ุงูู Request | ูุณุฎุฉ ูุงุญุฏุฉ                         |
| ูู ุญุตู ุฃูุซุฑ ูู Requestุ      | ูู Request ุจูุงุฎุฏ ูุณุฎุฉ ุฌุฏูุฏุฉ ุชูุงููุง |

---

## ุทูุจ ุชุนุงู ููุณ ุงูุณููุงุฑูู ุจุณ ูุฎูู ุงูู DbContext ุนุจุงุฑุฉ ุนู Transient:

* ูู ูุง ุงูู DI ูุญุงูู ูุญููู โ ุจูุนูู `new ApplicationDbContext()`.
* ูู ุงูููุชุฑููุฑ ููู 2 ุณูุฑููุณ ุจูุณุชุฎุฏููุง DbContext ููุฏุฉ ูู ูุงุญุฏ ูููู ููุณุชูู **ูุณุฎุฉ ูุฎุชููุฉ**.
* ููููู ูุญุตู:

  * ุชุถุงุฑุจ ูู ุงูู Tracking
  * ุงู Queries ูุด ูุชุฒุงููุฉ
  * ูุดุงูู ูู ุงูุญูุธ

>  ูุฐูู: ุงู **`DbContext` ุจู Transient = ุฎุทุฑ ุฅูุง ูู ุญุงูุงุช ูุญุฏุฏุฉ ุฌุฏูุง (ุบุงูุจูุง Testing).**

---

### ุทุจ ุชุนุงูู ูุฌุฑุจ ุงู  Singleton

* ููุง ุงูุฎุทูุฑุฉ ุฃูุจุฑ ุฌุฏูุง!
* ูุณุฎุฉ ูุงุญุฏุฉ ุจุณ ูู `DbContext` ููู ุงูุชุทุจูู.
* ูู Request ููู ูุณุชุฎุฏู ุจูุดุงุฑููุง ููุณ ุงูู Instance.

ุฏู ูุนูุงู:

* ูููู ุฑููููุณุชูู ููุฑูุง ุฃู ูุนุฏููุง ููุณ ุงููุงุฆู ูู ููุณ ุงูููุช!
* ุง **Concurrency violations**
* ุง **Dirty data**
* ุง **Memory leaks**

> ูุนูุดุงู ูุฏุฉ Singleton ูุน DbContext = **ูุตูุจุฉ ูู ุงูุฅูุชุงุฌ!**

---

## ุทูุจ ูุทุจู ุฏู ุนูู Service ุชุงููุฉ ูุด DbContext

### ูุซูุง: `ICurrencyConverter`

* ุฎุฏูุฉ ุจุชุญูู ุงูุนููุงุช.
* ุจุชุณุชุฎุฏู ูุนุฏูุงุช ูู API ุฎุงุฑุฌู ูุจุชุญูุธูู ูู ุงูุฐุงูุฑุฉ.

---

### ุชุณุชุฎุฏููุง ูู Singletonุ

* ุงูุงุฌุงุจุฉ ุขู.
* ูููุ ูุฃู:

  * ูุนุฏูุงุช ุงูุนููุงุช ูุด ุจุชุชุบูุฑ ูุชูุฑ.
  * ุงูุฎุฏูุฉ ููููุงุด State ูุชุนูู ุจู Request.
  * ุฃูุถู ุฃุนูููุง Cache ููุดุงุฑููุง ุจูู ูู ุงูู Requests.

---

### ุชุณุชุฎุฏููุง ูู Scoped ุฃู Transientุ

* ููููุ ุจุณ ุฏู Overkill.
* ูู Transient ููู Request ุจูุฌูุจ ูุณุฎุฉ ุฌุฏูุฏุฉ ูุฏู ูุนูู ุชุญููู ุฒูุงุฏุฉ ุนูู ุงูุฐุงูุฑุฉ.
* ูู Scoped ูุงููุด ูุงูุฏุฉุ ูุฃู ูููุด State ูุญุชุงุฌ ูุชุบูุฑ.

---

## ุงูููุงุฑูุฉ ุงูููุงุฆูุฉ ุจูู ุงูุฃููุงุน:

| ุงูุญุงูุฉ                     | Transient | Scoped          | Singleton         |
| -------------------------- | --------- | --------------- | ----------------- |
| ููุงุณุจ ูู DbContext         | โ         | โ               | โ                 |
| ููุงุณุจ ูู Utility Service   | โ         | โ               | โ                 |
| ุจูุนูู ูุณุฎุฉ ุฌุฏูุฏุฉ ูู ูุฑุฉุ   | โ         | โ (ููู Request) | โ (ูุฑุฉ ูุงุญุฏุฉ ููุท) |
| ูุดุงุฑู ุงููุงุฆู ุจูู Requestsุ | โ         | โ               | โ                 |

---

## ุฅุฒุงู ุชุนุฑู ุชุฎุชุงุฑุ

### ุงุณุฃู ููุณู:

1. ูู ุงูุฎุฏูุฉ ุจุชุญุชุงุฌ ุชุญุชูุธ ุจุญุงูุฉ ุฎูุงู ุงูู Requestุ โ ุงุณุชุฎุฏู Scoped.
2. ูู ุงูุฎุฏูุฉ Statelessุ ูููููุงุด ุฃู Request-specific dataุ โ ุงุณุชุฎุฏู Transient.
3. ูู ุงูุฎุฏูุฉ ูููุง ุจูุงูุงุช ุซุงุจุชุฉ ูุจุชุฎุฏู ูู ุงููุณุชุฎุฏูููุ โ Singleton.
